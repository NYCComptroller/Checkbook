widget_name,aggregate_table_name,create_table,query1,query2,execution_order
SpendingByCOAEntitiesAndFiscalYear,aggregateon_spending_coa_entities,"CREATE TABLE aggregateon_spending_coa_entities (
	department_id integer,
	agency_id smallint,
	spending_category_id smallint,
	expenditure_object_id integer,
	vendor_id integer,
	month_id int,
	year_id smallint,
	type_of_year char(1),
	total_spending_amount numeric(16,2),
	total_disbursements integer
	) DISTRIBUTED BY (department_id)  ","SELECT department_id,
		agency_id,
       	spending_category_id,
       	expenditure_object_id,   
       	vendor_id,
       	check_eft_issued_cal_month_id as month_id,
       	check_eft_issued_nyc_year_id as year_id,
       	'B' as type_of_year,
       	sum(check_amount) total_spending_amount,
       	count(*) as total_disbursements
  FROM disbursement_line_item_details 
  GROUP BY 1,2,3,4,5,6,7","SELECT 	department_id,
		agency_id,
       	spending_category_id,
       	expenditure_object_id,     
       	vendor_id,
       	check_eft_issued_cal_month_id AS month_id,
        calendar_fiscal_year_id AS year_id,
       	'C' as type_of_year,
       	sum(check_amount) total_spending_amount,
       	count(*) as total_disbursements
  FROM disbursement_line_item_details
  GROUP BY 1,2,3,4,5,6,7",1
SpendingByContractId,aggregateon_spending_contract,"CREATE TABLE aggregateon_spending_contract (
    agreement_id bigint,
    document_id character varying(20),
    document_code character varying(8),
	vendor_id integer,
	agency_id smallint,
	description character varying(60),	
	spending_category_id smallint,
	year_id smallint,
	type_of_year char(1),
	total_spending_amount numeric(16,2), 
	total_contract_amount numeric(16,2)
	) DISTRIBUTED BY (agreement_id)","SELECT agreement_id, contract_number, contract_document_code, vendor_id, agency_id, description,  
spending_category_id, year_id, type_of_year,
 sum(total_spending_amount) total_spending_amount,
  sum(contract_amount) total_contract_amount
FROM
(SELECT  agreement_id as agreement_id, 
       contract_number as contract_number,
       contract_document_code as contract_document_code,
       contract_vendor_id as vendor_id,
       contract_agency_id as agency_id,
       purpose as description,
       spending_category_id,
       check_eft_issued_nyc_year_id AS year_id,
       'B' as type_of_year,
       sum(check_amount) AS total_spending_amount,
       MAX(maximum_contract_amount) AS contract_amount
  FROM disbursement_line_item_details 
  WHERE agreement_id IS NOT NULL AND contract_number IS NOT NULL
GROUP BY 1,2,3,4,5,6,7,8,9
) X
GROUP BY 1,2,3,4,5,6,7,8,9 ","SELECT agreement_id, contract_number, contract_document_code, vendor_id, agency_id, description,  
 spending_category_id, year_id, type_of_year,
 sum(total_spending_amount) total_spending_amount,
  sum(contract_amount) total_contract_amount
  FROM
(SELECT  agreement_id as agreement_id,
       contract_number as contract_number,
       contract_document_code as contract_document_code,
       contract_vendor_id_cy as vendor_id,
       contract_agency_id_cy as agency_id,
       purpose_cy as description,
       calendar_fiscal_year_id AS year_id,   
       spending_category_id,
       'C' as type_of_year,
       sum(check_amount) AS total_spending_amount,
       MAX(maximum_contract_amount_cy) AS contract_amount
  FROM disbursement_line_item_details
  WHERE agreement_id IS NOT NULL AND contract_number IS NOT NULL
GROUP BY 1,2,3,4,5,6,7,8,9 ) X
 GROUP BY 1,2,3,4,5,6,7,8,9 ",2
SpendingByVendorId,aggregateon_spending_vendor,"CREATE TABLE aggregateon_spending_vendor (
	vendor_id integer,
	agency_id smallint,
	spending_category_id smallint,
	year_id smallint,
	type_of_year char(1),
	total_spending_amount numeric(16,2), 
	total_contract_amount numeric(16,2),
	is_all_categories char(1)
	) DISTRIBUTED BY (vendor_id)","SELECT X.vendor_id, X.agency_id, X.spending_category_id,   
       X.year_id,
       X.type_of_year,
       X.total_spending_amount,
       Y.total_contract_amount,
       'N' as is_all_categories
  FROM (SELECT agency_id,
               vendor_id,
               spending_category_id,
               check_eft_issued_nyc_year_id AS year_id,
               'B' as type_of_year,
               sum(check_amount) AS total_spending_amount
          FROM    disbursement_line_item_details a 
		  WHERE  a.spending_category_id <> 2
GROUP BY 1,2,3,4) X
LEFT JOIN (SELECT vendor_id, agency_id, spending_category_id, year_id, sum(total_contract_amount) as total_contract_amount
 FROM (SELECT agreement_id, vendor_id, agency_id, spending_category_id, year_id, MIN(total_contract_amount) as total_contract_amount
 FROM aggregateon_spending_contract WHERE type_of_year = 'B' 
 GROUP BY 1,2,3,4,5) Z 
 GROUP BY 1,2,3,4) Y
 ON X.vendor_id = Y.vendor_id AND X.agency_id = Y.agency_id AND X.spending_category_id = Y.spending_category_id AND X.year_id = Y.year_id 
 UNION ALL
   SELECT X.vendor_id, X.agency_id, X.spending_category_id::smallint,     
       X.year_id,
       X.type_of_year,
       X.total_spending_amount,
       Y.total_contract_amount,
       'Y' as is_all_categories
  FROM (SELECT agency_id,
               vendor_id,               
               check_eft_issued_nyc_year_id AS year_id,
               NULL as spending_category_id,
               'B' as type_of_year,
               sum(check_amount) AS total_spending_amount
          FROM    disbursement_line_item_details a 
		  WHERE  a.spending_category_id <> 2
GROUP BY 1,2,3) X
LEFT JOIN (SELECT vendor_id, agency_id, year_id, SUM(total_contract_amount) as total_contract_amount
FROM 
(SELECT agreement_id, vendor_id, agency_id, year_id, MIN(total_contract_amount) as total_contract_amount
 FROM aggregateon_spending_contract WHERE type_of_year = 'B' 
 GROUP BY 1,2,3,4) Z GROUP BY 1,2,3) Y
 ON X.vendor_id = Y.vendor_id AND X.agency_id = Y.agency_id AND X.year_id = Y.year_id","SELECT X.vendor_id, X.agency_id, X.spending_category_id, 
       X.year_id,
       X.type_of_year,
       X.total_spending_amount,
       Y.total_contract_amount,
       'N' as is_all_categories
  FROM (SELECT agency_id,
               vendor_id,
               spending_category_id,
               calendar_fiscal_year_id AS year_id,
               'C' as type_of_year,
               sum(check_amount) AS total_spending_amount
          FROM    disbursement_line_item_details a 
		  WHERE  a.spending_category_id <> 2
GROUP BY 1,2,3,4) X
LEFT JOIN (SELECT vendor_id, agency_id, spending_category_id, year_id, sum(total_contract_amount) as total_contract_amount
 FROM (SELECT agreement_id, vendor_id, agency_id, spending_category_id, year_id, MIN(total_contract_amount) as total_contract_amount
 FROM aggregateon_spending_contract WHERE type_of_year = 'C' 
 GROUP BY 1,2,3,4,5) Z 
 GROUP BY 1,2,3,4) Y
 ON X.vendor_id = Y.vendor_id AND X.agency_id = Y.agency_id AND X.spending_category_id = Y.spending_category_id AND X.year_id = Y.year_id 
 UNION ALL
   SELECT X.vendor_id, X.agency_id, X.spending_category_id::smallint,  
       X.year_id,
       X.type_of_year,
       X.total_spending_amount,
       Y.total_contract_amount,
       'Y' as is_all_categories
  FROM (SELECT agency_id,
               vendor_id,
               calendar_fiscal_year_id AS year_id,
               NULL as spending_category_id,
               'C' as type_of_year,
               sum(check_amount) AS total_spending_amount
          FROM    disbursement_line_item_details a 
		  WHERE  a.spending_category_id <> 2
GROUP BY 1,2,3) X
LEFT JOIN (SELECT vendor_id, agency_id, year_id, SUM(total_contract_amount) as total_contract_amount
FROM 
(SELECT agreement_id, vendor_id, agency_id, year_id, MIN(total_contract_amount) as total_contract_amount
 FROM aggregateon_spending_contract WHERE type_of_year = 'C' 
 GROUP BY 1,2,3,4) Z GROUP BY 1,2,3) Y
 ON X.vendor_id = Y.vendor_id AND X.agency_id = Y.agency_id AND X.year_id = Y.year_id ",3
SpendingByVendorExpObject,aggregateon_spending_vendor_exp_object,"CREATE TABLE aggregateon_spending_vendor_exp_object(
	vendor_id integer,
	expenditure_object_id integer,
	spending_category_id smallint,
	year_id smallint,
	type_of_year char(1),
	total_spending_amount numeric(16,2) )
DISTRIBUTED BY (expenditure_object_id)","SELECT vendor_id,expenditure_object_id,spending_category_id,
 check_eft_issued_nyc_year_id AS year_id, 'B' as type_of_year,SUM(check_amount) as total_spending_amount
 FROM disbursement_line_item_details
GROUP BY 1,2,3,4","SELECT vendor_id,expenditure_object_id,spending_category_id,
 calendar_fiscal_year_id AS year_id,  'C' as type_of_year,SUM(check_amount) as total_spending_amount
 FROM disbursement_line_item_details
GROUP BY 1,2,3,4",4
PopulateContractSpendingByYearAndCommodityTemp1,mid_aggregateon_disbursement_spending_year_and_commodity_temp1,"CREATE TABLE mid_aggregateon_disbursement_spending_year_and_commodity_temp1(
	original_agreement_id bigint,
	vendor_id int,
	agreement_commodity_line_number integer,
	fiscal_year smallint,	
	check_amount numeric(16,2))
DISTRIBUTED BY (original_agreement_id)","select  b.original_agreement_id, a.vendor_id, a.fms_commodity_line as agreement_commodity_line_number, year_value as fiscal_year, 0 as check_amount from oge_contract a , (select contract_number, original_agreement_id from history_agreement where original_version_flag = 'Y') b, (select * from ref_year where year_value >= 2010 and year_value <= 2014) c WHERE  a.fms_contract_number = b.contract_number ",,12
PopulateContractSpendingByYearAndCommodityTemp,mid_aggregateon_disbursement_spending_year_and_commodity_temp,"CREATE TABLE mid_aggregateon_disbursement_spending_year_and_commodity_temp(
	original_agreement_id bigint,
	vendor_id int,
	agreement_commodity_line_number integer,
	fiscal_year smallint,	
	check_amount numeric(16,2),
	type_of_year char(1))
DISTRIBUTED BY (original_agreement_id)","SELECT a.original_agreement_id, a.vendor_id, a.agreement_commodity_line_number, a.fiscal_year, sum(b.check_amount), a.type_of_year
FROM
( SELECT a.original_agreement_id, a.vendor_id, a.agreement_commodity_line_number as agreement_commodity_line_number, a.fiscal_year as fiscal_year, (CASE WHEN b.agreement_id IS NULL THEN  0 ELSE b.check_amount END) as check_amount, 'B' as type_of_year
FROM mid_aggregateon_disbursement_spending_year_and_commodity_temp1 a
LEFT JOIN
(SELECT agreement_id,
 vendor_id,
  agreement_commodity_line_number,
 a.fiscal_year,
 SUM(check_amount) as check_amount,
 'B' as type_of_year
FROM disbursement_line_item_details a WHERE agreement_id IS NOT NULL 
GROUP  BY 1,2,3,4,6) b  ON a.original_agreement_id = b.agreement_id AND a.vendor_id = b.vendor_id AND a.agreement_commodity_line_number = b.agreement_commodity_line_number AND a.fiscal_year = b.fiscal_year) a ,
( SELECT a.original_agreement_id, a.vendor_id, a.agreement_commodity_line_number as agreement_commodity_line_number, a.fiscal_year as fiscal_year, (CASE WHEN b.agreement_id IS NULL THEN  0 ELSE b.check_amount END) as check_amount, 'B' as type_of_year
FROM mid_aggregateon_disbursement_spending_year_and_commodity_temp1 a
LEFT JOIN
(SELECT agreement_id,
 vendor_id,
  agreement_commodity_line_number,
 a.fiscal_year,
 SUM(check_amount) as check_amount,
 'B' as type_of_year
FROM disbursement_line_item_details a WHERE agreement_id IS NOT NULL 
GROUP  BY 1,2,3,4,6) b  ON a.original_agreement_id = b.agreement_id AND a.vendor_id = b.vendor_id AND a.agreement_commodity_line_number = b.agreement_commodity_line_number AND a.fiscal_year = b.fiscal_year) b
WHERE a.original_agreement_id = b.original_agreement_id AND a.vendor_id = b.vendor_id AND a.agreement_commodity_line_number = b.agreement_commodity_line_number AND a.fiscal_year >= b.fiscal_year
GROUP BY 1,2,3,4,6 ","SELECT a.original_agreement_id, a.vendor_id,  a.agreement_commodity_line_number, a.calendar_fiscal_year, sum(b.check_amount), a.type_of_year
FROM
( SELECT a.original_agreement_id, a.vendor_id, a.agreement_commodity_line_number as agreement_commodity_line_number, a.fiscal_year as calendar_fiscal_year, (CASE WHEN b.agreement_id IS NULL THEN  0 ELSE b.check_amount END) as check_amount, 'C' as type_of_year
FROM mid_aggregateon_disbursement_spending_year_and_commodity_temp1 a
LEFT JOIN
(SELECT agreement_id,
vendor_id,
 agreement_commodity_line_number,
 a.calendar_fiscal_year,
 SUM(check_amount) as check_amount,
 'C' as type_of_year
FROM disbursement_line_item_details a WHERE  agreement_id IS NOT NULL
GROUP  BY 1,2,3,4,6) b  ON a.original_agreement_id = b.agreement_id AND a.vendor_id = b.vendor_id AND a.agreement_commodity_line_number = b.agreement_commodity_line_number AND a.fiscal_year = b.calendar_fiscal_year) a,
(SELECT a.original_agreement_id, a.vendor_id, a.agreement_commodity_line_number as agreement_commodity_line_number, a.fiscal_year as calendar_fiscal_year, (CASE WHEN b.agreement_id IS NULL THEN  0 ELSE b.check_amount END) as check_amount, 'C' as type_of_year
FROM mid_aggregateon_disbursement_spending_year_and_commodity_temp1 a
LEFT JOIN
(SELECT agreement_id,
vendor_id,
 agreement_commodity_line_number,
 a.calendar_fiscal_year,
 SUM(check_amount) as check_amount,
 'C' as type_of_year
FROM disbursement_line_item_details a WHERE  agreement_id IS NOT NULL
GROUP  BY 1,2,3,4,6) b  ON a.original_agreement_id = b.agreement_id AND a.vendor_id = b.vendor_id AND a.agreement_commodity_line_number = b.agreement_commodity_line_number AND a.fiscal_year = b.calendar_fiscal_year) b 
WHERE a.original_agreement_id = b.original_agreement_id AND a.vendor_id = b.vendor_id AND a.agreement_commodity_line_number = b.agreement_commodity_line_number AND a.calendar_fiscal_year >= b.calendar_fiscal_year
GROUP BY 1,2,3,4,6 ",13
PopulateContractSpendingByYearAndCommodity,mid_aggregateon_disbursement_spending_year_and_commodity,"CREATE TABLE mid_aggregateon_disbursement_spending_year_and_commodity(
	original_agreement_id bigint,
	vendor_id int,
	agreement_commodity_line_number integer,
	fiscal_year smallint,	
	check_amount numeric(16,2),
	type_of_year char(1))
DISTRIBUTED BY (original_agreement_id)","SELECT a.original_agreement_id, a.vendor_id, a.agreement_commodity_line_number, a.fiscal_year, sum(b.check_amount), a.type_of_year
FROM
mid_aggregateon_disbursement_spending_year_and_commodity_temp a ,
mid_aggregateon_disbursement_spending_year_and_commodity_temp b
WHERE a.original_agreement_id = b.original_agreement_id AND a.vendor_id = b.vendor_id AND a.agreement_commodity_line_number >= b.agreement_commodity_line_number AND a.fiscal_year = b.fiscal_year AND a.type_of_year = b.type_of_year
GROUP BY 1,2,3,4,6 ",,14
PopulateContractSpendingByYear,mid_aggregateon_disbursement_spending_year,"CREATE TABLE mid_aggregateon_disbursement_spending_year(
	original_agreement_id bigint,
	vendor_id int,
	fiscal_year smallint,
	fiscal_year_id smallint,	
	check_amount numeric(16,2),
	type_of_year char(1),
	master_agreement_yn character(1))
DISTRIBUTED BY (original_agreement_id)","SELECT agreement_id,
  contract_vendor_id as vendor_id,
 a.fiscal_year,
 year_id,
 SUM(check_amount),
 'B' as type_of_year,
 'N' as master_agreement_yn 
FROM disbursement_line_item_details a JOIN ref_year b ON a.fiscal_year = b.year_value AND agreement_id IS NOT NULL
GROUP  BY 1,2,3,4,6,7
UNION ALL
SELECT agreement_id,
 contract_vendor_id_cy as vendor_id,
 a.calendar_fiscal_year,
 year_id,
 SUM(check_amount),
 'C' as type_of_year,
 'N' as master_agreement_yn
FROM disbursement_line_item_details a JOIN ref_year b ON a.calendar_fiscal_year = b.year_value AND agreement_id IS NOT NULL
GROUP  BY 1,2,3,4,6,7","SELECT master_agreement_id,
 contract_vendor_id as vendor_id,
 a.fiscal_year,
 year_id,
 SUM(check_amount),
 'B' as type_of_year,
 'Y' as master_agreement_yn
FROM disbursement_line_item_details a JOIN ref_year b ON a.fiscal_year = b.year_value AND master_agreement_id IS NOT NULL
GROUP  BY 1,2,3,4,6,7
UNION ALL
SELECT master_agreement_id,
 contract_vendor_id_cy as vendor_id,
 a.calendar_fiscal_year,
 year_id,
 SUM(check_amount),
 'C' as type_of_year,
 'Y' as master_agreement_yn
FROM disbursement_line_item_details a JOIN ref_year b ON a.calendar_fiscal_year = b.year_value AND master_agreement_id IS NOT NULL
GROUP  BY 1,2,3,4,6,7",15
ContractLandingWidgets,aggregateon_contracts_cumulative_spending,"CREATE TABLE aggregateon_contracts_cumulative_spending(
	original_agreement_id bigint,
	fiscal_year smallint,
	fiscal_year_id smallint,
	document_code_id smallint,
	master_agreement_yn character(1),
	description varchar,
	contract_number varchar,
	vendor_id int,
	award_method_id smallint,
	agency_id smallint,
	industry_type_id smallint,
	award_size_id smallint,
	original_contract_amount numeric(16,2),
	maximum_contract_amount numeric(16,2),
	spending_amount_disb numeric(16,2),
	spending_amount numeric(16,2),
	current_year_spending_amount numeric(16,2),
	dollar_difference numeric(16,2),
	percent_difference numeric(16,2),
	display_agency_id smallint,
	display_vendor_id int,
	status_flag char(1),
	type_of_year char(1)	
) DISTRIBUTED BY (vendor_id)","SELECT  a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		a.master_agreement_yn,
		MIN(description),
		MIN(contract_number),
		a.vendor_id,
		MIN(award_method_id),
		MIN(a.agency_id) ,
		MIN(industry_type_id),
		MIN(award_size_id),
		MIN(original_contract_amount),
		MIN(maximum_contract_amount),
		SUM(coalesce(b.check_amount,0)),
		MIN(a.rfed_amount),
		SUM(CASE WHEN b.fiscal_year IS NOT NULL AND a.fiscal_year = b.fiscal_year THEN coalesce(b.check_amount,0) ELSE 0 END) as current_year_spending_amount,
		MIN(dollar_difference),
		MIN(percent_difference),
		(CASE WHEN a.master_agreement_yn = 'Y' THEN agedc.agency_id ELSE a.agency_id END) as display_agency_id,
		(CASE WHEN a.master_agreement_yn = 'Y' THEN agedc.vendor_id ELSE a.vendor_id END) as display_vendor_id,
		'A' as status_flag,
		'B' as type_of_year
	FROM 	agreement_snapshot_expanded a 
	LEFT JOIN (SELECT agreement_id, fiscal_year, status_flag, master_agreement_yn, vendor_id + 100000 as vendor_id, agency_id FROM agreement_snapshot_expanded_edc  WHERE master_agreement_yn = 'Y' AND status_flag='A') agedc ON a.agreement_id =  agedc.agreement_id AND a.fiscal_year = agedc.fiscal_year AND a.status_flag = agedc.status_flag AND a.master_agreement_yn = agedc.master_agreement_yn
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN mid_aggregateon_disbursement_spending_year b ON a.original_agreement_id = b.original_agreement_id AND a.vendor_id = b.vendor_id AND a.fiscal_year >= b.fiscal_year AND b.type_of_year ='B'
	WHERE  a.status_flag='A'
	GROUP BY 1,2,3,4,5,8,20,21
UNION ALL
SELECT a.original_agreement_id,
	a.fiscal_year,
	ry.year_id,
	document_code_id,
	a.master_agreement_yn,
	MIN(description),
	MIN(contract_number),
	a.vendor_id,
	MIN(award_method_id),
	MIN(a.agency_id) ,
	MIN(industry_type_id),
	MIN(award_size_id),
	MIN(original_contract_amount),
	MIN(maximum_contract_amount),
	SUM(coalesce(b.check_amount,0)) ,
	MIN(a.rfed_amount),
	SUM(CASE WHEN b.fiscal_year IS NOT NULL AND a.fiscal_year = b.fiscal_year THEN coalesce(b.check_amount,0) ELSE 0 END) as current_year_spending_amount,
	MIN(dollar_difference),
	MIN(percent_difference),
	(CASE WHEN a.master_agreement_yn = 'Y' THEN agedc.agency_id ELSE a.agency_id END) as display_agency_id,
	(CASE WHEN a.master_agreement_yn = 'Y' THEN agedc.vendor_id ELSE a.vendor_id END) as display_vendor_id,
	'R' as status_flag, 
	'B' as type_of_year	
	FROM 	agreement_snapshot_expanded a 
	LEFT JOIN (SELECT agreement_id, fiscal_year, status_flag, master_agreement_yn, vendor_id + 100000 as vendor_id, agency_id FROM agreement_snapshot_expanded_edc  WHERE master_agreement_yn = 'Y' AND status_flag='R') agedc ON a.agreement_id =  agedc.agreement_id AND a.fiscal_year = agedc.fiscal_year AND a.status_flag = agedc.status_flag AND a.master_agreement_yn = agedc.master_agreement_yn
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN mid_aggregateon_disbursement_spending_year b ON a.original_agreement_id = b.original_agreement_id AND a.vendor_id = b.vendor_id AND a.fiscal_year >= b.fiscal_year AND b.type_of_year ='B' 
	WHERE   a.status_flag='R'
	GROUP BY 1,2,3,4,5,8,20,21","SELECT  a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		a.master_agreement_yn,
		MIN(description),
		MIN(contract_number),
		a.vendor_id,
		MIN(award_method_id),
		MIN(a.agency_id) ,
		MIN(industry_type_id),
		MIN(award_size_id),
		MIN(original_contract_amount),
		MIN(maximum_contract_amount),
		SUM(coalesce(b.check_amount,0)),
		MIN(a.rfed_amount),
		SUM(CASE WHEN b.fiscal_year IS NOT NULL AND a.fiscal_year = b.fiscal_year THEN coalesce(b.check_amount,0) ELSE 0 END) as current_year_spending_amount,
		MIN(dollar_difference),
		MIN(percent_difference),
		(CASE WHEN a.master_agreement_yn = 'Y' THEN agedc.agency_id ELSE a.agency_id END) as display_agency_id,
		(CASE WHEN a.master_agreement_yn = 'Y' THEN agedc.vendor_id ELSE a.vendor_id END) as display_vendor_id,
		'A' as status_flag,
		'C' as type_of_year
	FROM 	agreement_snapshot_expanded_cy a 
	LEFT JOIN (SELECT agreement_id, fiscal_year, status_flag, master_agreement_yn, vendor_id + 100000 as vendor_id, agency_id FROM agreement_snapshot_expanded_cy_edc  WHERE master_agreement_yn = 'Y' AND status_flag='A') agedc ON a.agreement_id =  agedc.agreement_id AND a.fiscal_year = agedc.fiscal_year AND a.status_flag = agedc.status_flag AND a.master_agreement_yn = agedc.master_agreement_yn
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN mid_aggregateon_disbursement_spending_year b ON a.original_agreement_id = b.original_agreement_id AND a.vendor_id = b.vendor_id AND a.fiscal_year >= b.fiscal_year AND b.type_of_year ='C'
	WHERE  a.status_flag='A'
	GROUP BY 1,2,3,4,5,8,20,21
UNION ALL
SELECT a.original_agreement_id,
	a.fiscal_year,
	ry.year_id,
	document_code_id,
	a.master_agreement_yn,
	MIN(description),
	MIN(contract_number),
	a.vendor_id,
	MIN(award_method_id),
	MIN(a.agency_id),
	MIN(industry_type_id),
	MIN(award_size_id),
	MIN(original_contract_amount),
	MIN(maximum_contract_amount),
	SUM(coalesce(b.check_amount,0)) ,
	MIN(a.rfed_amount),
	SUM(CASE WHEN b.fiscal_year IS NOT NULL AND a.fiscal_year = b.fiscal_year THEN coalesce(b.check_amount,0) ELSE 0 END) as current_year_spending_amount,
	MIN(dollar_difference),
	MIN(percent_difference),
	(CASE WHEN a.master_agreement_yn = 'Y' THEN agedc.agency_id ELSE a.agency_id END) as display_agency_id,
	(CASE WHEN a.master_agreement_yn = 'Y' THEN agedc.vendor_id ELSE a.vendor_id END) as display_vendor_id,
	'R' as status_flag, 
	'C' as type_of_year	
	FROM 	agreement_snapshot_expanded_cy a
LEFT JOIN (SELECT agreement_id, fiscal_year, status_flag, master_agreement_yn, vendor_id + 100000 as vendor_id, agency_id FROM agreement_snapshot_expanded_cy_edc  WHERE master_agreement_yn = 'Y' AND status_flag='R') agedc ON a.agreement_id =  agedc.agreement_id AND a.fiscal_year = agedc.fiscal_year AND a.status_flag = agedc.status_flag AND a.master_agreement_yn = agedc.master_agreement_yn	
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN mid_aggregateon_disbursement_spending_year b ON a.original_agreement_id = b.original_agreement_id AND a.vendor_id = b.vendor_id AND a.fiscal_year >= b.fiscal_year AND b.type_of_year ='C'
	WHERE   a.status_flag='R'
	GROUP BY 1,2,3,4,5,8,20,21",16
ContractLandingTopGraph,aggregateon_contracts_spending_by_month,"CREATE TABLE aggregateon_contracts_spending_by_month(
 original_agreement_id bigint,
 fiscal_year smallint,
 fiscal_year_id smallint,
 document_code_id smallint,
 month_id integer,
 vendor_id int,
 award_method_id smallint,
 agency_id smallint,
 industry_type_id smallint,
 award_size_id smallint,
 spending_amount numeric(16,2),
 status_flag char(1),
 type_of_year char(1) 
) DISTRIBUTED BY (vendor_id)","SELECT  a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		b.check_eft_issued_cal_month_id as month_id,		
		a.vendor_id,
		a.award_method_id,
		a.agency_id ,
		a.industry_type_id,
		a.award_size_id,
		SUM(coalesce(b.check_amount,0)),		
		'A' as status_flag,
		'B' as type_of_year
	FROM 	agreement_snapshot_expanded a 
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN disbursement_line_item_details b ON a.original_agreement_id = b.agreement_id AND a.vendor_id = b.vendor_id AND a.fiscal_year = b.fiscal_year 
	WHERE  a.status_flag='A' AND a.master_agreement_yn = 'N'
	GROUP BY 1,2,3,4,5,6,7,8,9,10
UNION ALL
SELECT  a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		b.check_eft_issued_cal_month_id as month_id,		
		a.vendor_id,
		a.award_method_id,
		a.agency_id ,
		a.industry_type_id,
		a.award_size_id,
		SUM(coalesce(b.check_amount,0)),		
		'A' as status_flag,
		'B' as type_of_year
	FROM 	agreement_snapshot_expanded a 
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN disbursement_line_item_details b ON a.original_agreement_id = b.master_agreement_id AND a.vendor_id = b.vendor_id AND a.fiscal_year = b.fiscal_year 
	WHERE  a.status_flag='A' AND a.master_agreement_yn = 'Y'
	GROUP BY 1,2,3,4,5,6,7,8,9,10
UNION ALL
SELECT a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		b.check_eft_issued_cal_month_id as month_id,		
		a.vendor_id,
		a.award_method_id,
		a.agency_id ,	
		a.industry_type_id,
		a.award_size_id,
		SUM(coalesce(b.check_amount,0)),
		'R' as status_flag, 
		'B' as type_of_year	
	FROM 	agreement_snapshot_expanded a 
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN disbursement_line_item_details b ON a.original_agreement_id = b.agreement_id AND a.vendor_id = b.vendor_id AND a.fiscal_year = b.fiscal_year 
	WHERE   a.status_flag='R' AND a.master_agreement_yn = 'N'
	GROUP BY 1,2,3,4,5,6,7,8,9,10
UNION ALL
SELECT a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		b.check_eft_issued_cal_month_id as month_id,		
		a.vendor_id,
		a.award_method_id,
		a.agency_id ,	
		a.industry_type_id,
		a.award_size_id,
		SUM(coalesce(b.check_amount,0)),
		'R' as status_flag, 
		'B' as type_of_year	
	FROM 	agreement_snapshot_expanded a 
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN disbursement_line_item_details b ON a.original_agreement_id = b.master_agreement_id AND a.vendor_id = b.vendor_id AND a.fiscal_year = b.fiscal_year 
	WHERE   a.status_flag='R' AND a.master_agreement_yn = 'Y'
	GROUP BY 1,2,3,4,5,6,7,8,9,10 ","SELECT  a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		b.check_eft_issued_cal_month_id as month_id,		
		a.vendor_id,
		a.award_method_id,
		a.agency_id ,	
		a.industry_type_id,
		a.award_size_id,
		SUM(coalesce(b.check_amount,0)),
		'A' as status_flag,
		'C' as type_of_year
	FROM 	agreement_snapshot_expanded_cy a 
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN disbursement_line_item_details b ON a.original_agreement_id = b.agreement_id AND a.vendor_id = b.vendor_id AND a.fiscal_year = b.calendar_fiscal_year 
	WHERE  a.status_flag='A' AND a.master_agreement_yn = 'N'
	GROUP BY 1,2,3,4,5,6,7,8,9,10
UNION ALL
SELECT  a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		b.check_eft_issued_cal_month_id as month_id,		
		a.vendor_id,
		a.award_method_id,
		a.agency_id ,	
		a.industry_type_id,
		a.award_size_id,
		SUM(coalesce(b.check_amount,0)),
		'A' as status_flag,
		'C' as type_of_year
	FROM 	agreement_snapshot_expanded_cy a 
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN disbursement_line_item_details b ON a.original_agreement_id = b.master_agreement_id AND a.vendor_id = b.vendor_id AND a.fiscal_year = b.calendar_fiscal_year 
	WHERE  a.status_flag='A' AND a.master_agreement_yn = 'Y'
	GROUP BY 1,2,3,4,5,6,7,8,9,10
UNION ALL
SELECT  a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		b.check_eft_issued_cal_month_id as month_id,		
		a.vendor_id,
		a.award_method_id,
		a.agency_id ,	
		a.industry_type_id,
		a.award_size_id,
		SUM(coalesce(b.check_amount,0)),
	'R' as status_flag, 
	'C' as type_of_year	
	FROM 	agreement_snapshot_expanded_cy a 
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN disbursement_line_item_details b ON a.original_agreement_id = b.agreement_id AND a.vendor_id = b.vendor_id AND a.fiscal_year = b.calendar_fiscal_year 
	WHERE   a.status_flag='R' AND a.master_agreement_yn = 'N'
	GROUP BY 1,2,3,4,5,6,7,8,9,10
UNION ALL
SELECT  a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		b.check_eft_issued_cal_month_id as month_id,		
		a.vendor_id,
		a.award_method_id,
		a.agency_id ,	
		a.industry_type_id,
		a.award_size_id,
		SUM(coalesce(b.check_amount,0)),
	'R' as status_flag, 
	'C' as type_of_year	
	FROM 	agreement_snapshot_expanded_cy a 
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN disbursement_line_item_details b ON a.original_agreement_id = b.master_agreement_id AND a.vendor_id = b.vendor_id AND a.fiscal_year = b.calendar_fiscal_year 
	WHERE   a.status_flag='R' AND a.master_agreement_yn = 'Y'
	GROUP BY 1,2,3,4,5,6,7,8,9,10 ",17
ContractsForSumAndTotals,aggregateon_total_contracts,"CREATE TABLE aggregateon_total_contracts
(
fiscal_year smallint,
fiscal_year_id smallint,
vendor_id int,
award_method_id smallint,
agency_id smallint,
industry_type_id smallint,
award_size_id smallint,
total_contracts bigint,
total_commited_contracts bigint,
total_master_agreements bigint,
total_standalone_contracts bigint,
total_revenue_contracts bigint,
total_revenue_contracts_amount numeric(16,2),
total_commited_contracts_amount numeric(16,2),
total_contracts_amount numeric(16,2),
total_spending_amount_disb numeric(16,2), 
total_spending_amount numeric(16,2), 
status_flag char(1),
type_of_year char(1)
) DISTRIBUTED BY (fiscal_year)","SELECT 	fiscal_year, 
		fiscal_year_id,
		vendor_id,
		award_method_id,
		agency_id,
		industry_type_id,
		award_size_id,
		SUM(CASE WHEN b.document_code IN ('MA1','MMA1','CT1','CTA1') THEN 1 ELSE 0 END) AS    total_contracts,
		SUM(CASE WHEN b.document_code IN ('MA1','MMA1','CT1') THEN 1 ELSE 0 END) AS total_commited_contracts,
		SUM(CASE WHEN b.document_code IN ('MA1','MMA1') THEN 1 ELSE 0 END) AS total_master_agreements,
		SUM(CASE WHEN b.document_code IN ('CT1','CTA1') THEN  1 ELSE 0 END) AS total_standalone_contracts,
		SUM(CASE WHEN b.document_code IN ('RCT1') THEN  1 ELSE 0 END) AS total_revenue_contracts,
		SUM(CASE WHEN b.document_code IN ('RCT1') THEN  maximum_contract_amount ELSE 0 END) AS total_revenue_contracts_amount,
		SUM(CASE WHEN b.document_code IN ('MA1','MMA1','CT1') THEN maximum_contract_amount ELSE 0 END) AS total_commited_contracts_amount,
		SUM(CASE WHEN b.document_code IN ('MA1','MMA1','CT1','CTA1') THEN maximum_contract_amount ELSE 0 END) AS total_contracts_amount,
		SUM(CASE WHEN b.document_code IN ('CT1','CTA1','DO1') THEN spending_amount_disb ELSE 0 END) as total_spending_amount_disb,
		SUM(CASE WHEN b.document_code IN ('CT1','CTA1','DO1') THEN spending_amount ELSE 0 END) as total_spending_amount,
		status_flag,
		type_of_year
FROM aggregateon_contracts_cumulative_spending a LEFT JOIN ref_document_code b ON a.document_code_id = b.document_code_id
GROUP BY 1,2,3,4,5,6,7,18,19",,18
ContractsByAppropriationUnit,aggregateon_contracts_department,"CREATE TABLE aggregateon_contracts_department(
	document_code_id smallint,
	agency_id smallint,
	department_id integer,
	fiscal_year smallint,
	fiscal_year_id smallint,
	award_method_id smallint,
	vendor_id int,
	industry_type_id smallint,
	award_size_id smallint,
	spending_amount_disb numeric(16,2),
	spending_amount numeric(16,2),
	total_contracts integer,
	status_flag char(1),
	type_of_year char(1)
) DISTRIBUTED BY (department_id)","SELECT a.document_code_id,
 		a.agency_id as agency_id,
		ogecon.department_id as department_id,
		a.fiscal_year,
		a.fiscal_year_id,
		a.award_method_id,
		a.vendor_id,
		a.industry_type_id,
		a.award_size_id,
		sum(coalesce(a.spending_amount_disb,0)) as spending_amount_disb,
		sum(coalesce(a.spending_amount,0)) as spending_amount,
		count(distinct a.original_agreement_id) as total_contracts,
		'A' as status_flag,
		'B' as type_of_year
 FROM aggregateon_contracts_cumulative_spending a 
 JOIN (SELECT agency_id, vendor_id, department_id, fms_contract_number, max(current_amount) as current_amount, max(original_amount) as original_amount
	FROM oge_contract	GROUP BY 1,2,3,4)  ogecon ON a.contract_number = ogecon.fms_contract_number AND a.vendor_id = ogecon.vendor_id  
 WHERE  a.master_agreement_yn = 'N' AND a.status_flag='A' AND a.type_of_year = 'B' GROUP BY 1,2,3,4,5,6,7,8,9	
 UNION ALL 
 SELECT a.document_code_id,
 		a.agency_id as agency_id,
		ogecon.department_id as department_id,
		a.fiscal_year,
		a.fiscal_year_id,
		a.award_method_id,
		a.vendor_id,
		a.industry_type_id,
		a.award_size_id,
		sum(coalesce(a.spending_amount_disb,0)) as spending_amount_disb,
		sum(coalesce(a.spending_amount,0)) as spending_amount,
		count(distinct a.original_agreement_id) as total_contracts,
		'A' as status_flag,
		'R' as type_of_year
 FROM aggregateon_contracts_cumulative_spending a 
 JOIN (SELECT agency_id, vendor_id, department_id, fms_contract_number, max(current_amount) as current_amount, max(original_amount) as original_amount
	FROM oge_contract	GROUP BY 1,2,3,4)  ogecon ON a.contract_number = ogecon.fms_contract_number AND a.vendor_id = ogecon.vendor_id  
 WHERE  a.master_agreement_yn = 'N' AND a.status_flag='R' AND a.type_of_year = 'B' GROUP BY 1,2,3,4,5,6,7,8,9","SELECT a.document_code_id,
 		a.agency_id as agency_id,
		ogecon.department_id as department_id,
		a.fiscal_year,
		a.fiscal_year_id,
		a.award_method_id,
		a.vendor_id,
		a.industry_type_id,
		a.award_size_id,
		sum(coalesce(a.spending_amount_disb,0)) as spending_amount_disb,
		sum(coalesce(a.spending_amount,0)) as spending_amount,
		count(distinct a.original_agreement_id) as total_contracts,
		'A' as status_flag,
		'C' as type_of_year
 FROM aggregateon_contracts_cumulative_spending a 
 JOIN (SELECT agency_id, vendor_id, department_id, fms_contract_number, max(current_amount) as current_amount, max(original_amount) as original_amount
	FROM oge_contract	GROUP BY 1,2,3,4)  ogecon ON a.contract_number = ogecon.fms_contract_number AND a.vendor_id = ogecon.vendor_id  
 WHERE  a.master_agreement_yn = 'N' AND a.status_flag='A' AND a.type_of_year = 'C' GROUP BY 1,2,3,4,5,6,7,8,9	
 UNION ALL 
 SELECT a.document_code_id,
 		a.agency_id as agency_id,
		ogecon.department_id as department_id,
		a.fiscal_year,
		a.fiscal_year_id,
		a.award_method_id,
		a.vendor_id,
		a.industry_type_id,
		a.award_size_id,
		sum(coalesce(a.spending_amount_disb,0)) as spending_amount_disb,
		sum(coalesce(a.spending_amount,0)) as spending_amount,
		count(distinct a.original_agreement_id) as total_contracts,
		'A' as status_flag,
		'R' as type_of_year
 FROM aggregateon_contracts_cumulative_spending a 
 JOIN (SELECT agency_id, vendor_id, department_id, fms_contract_number, max(current_amount) as current_amount, max(original_amount) as original_amount
	FROM oge_contract	GROUP BY 1,2,3,4)  ogecon ON a.contract_number = ogecon.fms_contract_number AND a.vendor_id = ogecon.vendor_id  
 WHERE  a.master_agreement_yn = 'N' AND a.status_flag='R' AND a.type_of_year = 'C' GROUP BY 1,2,3,4,5,6,7,8,9",19
ContractsSpendingTransactions,contracts_spending_transactions,"CREATE TABLE contracts_spending_transactions
(
disbursement_line_item_id bigint,
original_agreement_id bigint,
fiscal_year smallint,
fiscal_year_id smallint,
document_code_id smallint,
vendor_id int,
award_method_id smallint,
document_agency_id smallint,
industry_type_id smallint,
award_size_id smallint,
disb_document_id  character varying(20),
disb_vendor_name  character varying,
disb_check_eft_issued_date  date,
disb_agency_name  character varying(100),
disb_department_short_name  character varying(15),
disb_check_amount  numeric(16,2),
disb_expenditure_object_name  character varying(40),
disb_budget_name  character varying(60),
disb_contract_number  character varying,
disb_purpose  character varying,
disb_reporting_code  character varying(15),
disb_spending_category_name  character varying,
disb_agency_id  smallint,
disb_vendor_id  integer,
disb_expenditure_object_id  integer,
disb_department_id  integer,
disb_spending_category_id  smallint,
disb_agreement_id  bigint,
disb_contract_document_code  character varying(8),
disb_master_agreement_id  bigint,
disb_fiscal_year_id  smallint,
disb_check_eft_issued_cal_month_id integer,
disb_disbursement_number character varying(40),
disb_agreement_commodity_line_number integer,
oge_contract_number character varying(15),
oge_budget_name character varying(75),
status_flag char(1),
type_of_year char(1)
) DISTRIBUTED BY (disbursement_line_item_id)","SELECT 	d.disbursement_line_item_id, 
		a.original_agreement_id,
		a.fiscal_year,
		b.year_id,
		a.document_code_id,
		a.vendor_id,
		a.award_method_id,
		a.agency_id as document_agency_id,
		a.industry_type_id,
		a.award_size_id,
		d.document_id,
		d.vendor_name,
		d.check_eft_issued_date,
		d.agency_name,
		d.department_short_name,
		d.check_amount,
		d.expenditure_object_name,
		d.budget_name,
		d.contract_number,
		d.purpose,
		d.reporting_code,
		d.spending_category_name,
		d.agency_id,
		d.vendor_id,
		d.expenditure_object_id,
		d.department_id,
		d.spending_category_id,
		d.agreement_id,
		d.contract_document_code,
		d.master_agreement_id,
		d.check_eft_issued_nyc_year_id,
		d.check_eft_issued_cal_month_id,
		d.disbursement_number,
		d.agreement_commodity_line_number,
		e.oge_contract_number,
		e.budget_name as oge_budget_name,
		'A' as status_flag,
		'B' as type_of_year
FROM   agreement_snapshot_expanded a, ref_year b, disbursement_line_item_details d, oge_contract e
WHERE a.fiscal_year = b.year_value 
AND a.original_agreement_id = d.agreement_id  AND a.vendor_id = d.vendor_id AND a.fiscal_year >= d.fiscal_year
AND d.contract_number = e.fms_contract_number AND d.agreement_commodity_line_number = e.fms_commodity_line
AND a.status_flag='A' AND a.master_agreement_yn = 'N'
UNION ALL
SELECT 	d.disbursement_line_item_id, 
		a.original_agreement_id,
		a.fiscal_year,
		b.year_id,
		a.document_code_id,
		a.vendor_id,
		a.award_method_id,
		a.agency_id as document_agency_id,
		a.industry_type_id,
		a.award_size_id,
		d.document_id,
		d.vendor_name,
		d.check_eft_issued_date,
		d.agency_name,
		d.department_short_name,
		d.check_amount,
		d.expenditure_object_name,
		d.budget_name,
		d.contract_number,
		d.purpose,
		d.reporting_code,
		d.spending_category_name,
		d.agency_id,
		d.vendor_id,
		d.expenditure_object_id,
		d.department_id,
		d.spending_category_id,
		d.agreement_id,
		d.contract_document_code,
		d.master_agreement_id,
		d.check_eft_issued_nyc_year_id,
		d.check_eft_issued_cal_month_id,
		d.disbursement_number,
		d.agreement_commodity_line_number,
		e.oge_contract_number,
		e.budget_name as oge_budget_name,
		'A' as status_flag,
		'B' as type_of_year
FROM   agreement_snapshot_expanded a, ref_year b, disbursement_line_item_details d, oge_contract e
WHERE a.fiscal_year = b.year_value 
AND a.original_agreement_id = d.master_agreement_id  AND a.vendor_id = d.vendor_id AND a.fiscal_year >= d.fiscal_year
AND d.contract_number = e.fms_contract_number AND d.agreement_commodity_line_number = e.fms_commodity_line
AND a.status_flag='A' AND a.master_agreement_yn = 'Y'
UNION ALL
 SELECT d.disbursement_line_item_id, 
		a.original_agreement_id,
		a.fiscal_year,
		b.year_id,
		a.document_code_id,
		a.vendor_id,
		a.award_method_id,
		a.agency_id as document_agency_id,
		a.industry_type_id,
		a.award_size_id,
		d.document_id,
		d.vendor_name,
		d.check_eft_issued_date,
		d.agency_name,
		d.department_short_name,
		d.check_amount,
		d.expenditure_object_name,
		d.budget_name,
		d.contract_number,
		d.purpose,
		d.reporting_code,
		d.spending_category_name,
		d.agency_id,
		d.vendor_id,
		d.expenditure_object_id,
		d.department_id,
		d.spending_category_id,
		d.agreement_id,
		d.contract_document_code,
		d.master_agreement_id,
		d.check_eft_issued_nyc_year_id,
		d.check_eft_issued_cal_month_id,
		d.disbursement_number,
		d.agreement_commodity_line_number,
		e.oge_contract_number,
		e.budget_name as oge_budget_name,
		'R' as status_flag,
		'B' as type_of_year
FROM   agreement_snapshot_expanded a, ref_year b, disbursement_line_item_details d, oge_contract e
WHERE a.fiscal_year = b.year_value 
AND a.original_agreement_id = d.agreement_id  AND a.vendor_id = d.vendor_id AND a.fiscal_year >= d.fiscal_year
AND d.contract_number = e.fms_contract_number AND d.agreement_commodity_line_number = e.fms_commodity_line
AND a.status_flag='R' AND a.master_agreement_yn = 'N' 
UNION ALL
 SELECT d.disbursement_line_item_id, 
		a.original_agreement_id,
		a.fiscal_year,
		b.year_id,
		a.document_code_id,
		a.vendor_id,
		a.award_method_id,
		a.agency_id as document_agency_id,
		a.industry_type_id,
		a.award_size_id,
		d.document_id,
		d.vendor_name,
		d.check_eft_issued_date,
		d.agency_name,
		d.department_short_name,
		d.check_amount,
		d.expenditure_object_name,
		d.budget_name,
		d.contract_number,
		d.purpose,
		d.reporting_code,
		d.spending_category_name,
		d.agency_id,
		d.vendor_id,
		d.expenditure_object_id,
		d.department_id,
		d.spending_category_id,
		d.agreement_id,
		d.contract_document_code,
		d.master_agreement_id,
		d.check_eft_issued_nyc_year_id,
		d.check_eft_issued_cal_month_id,
		d.disbursement_number,
		d.agreement_commodity_line_number,
		e.oge_contract_number,
		e.budget_name as oge_budget_name,
		'R' as status_flag,
		'B' as type_of_year
FROM   agreement_snapshot_expanded a, ref_year b, disbursement_line_item_details d, oge_contract e
WHERE a.fiscal_year = b.year_value 
AND a.original_agreement_id = d.master_agreement_id  AND a.vendor_id = d.vendor_id AND a.fiscal_year >= d.fiscal_year
AND d.contract_number = e.fms_contract_number AND d.agreement_commodity_line_number = e.fms_commodity_line
AND a.status_flag='R' AND a.master_agreement_yn = 'Y' ","SELECT d.disbursement_line_item_id, 
		a.original_agreement_id,
		a.fiscal_year,
		b.year_id,
		a.document_code_id,
		a.vendor_id,
		a.award_method_id,
		a.agency_id as document_agency_id,
		a.industry_type_id,
		a.award_size_id,
		d.document_id,
		d.vendor_name,
		d.check_eft_issued_date,
		d.agency_name,
		d.department_short_name,
		d.check_amount,
		d.expenditure_object_name,
		d.budget_name,
		d.contract_number,
		d.purpose,
		d.reporting_code,
		d.spending_category_name,
		d.agency_id,
		d.vendor_id,
		d.expenditure_object_id,
		d.department_id,
		d.spending_category_id,
		d.agreement_id,
		d.contract_document_code,
		d.master_agreement_id,
		d.calendar_fiscal_year_id,
		d.check_eft_issued_cal_month_id,
		d.disbursement_number,
		d.agreement_commodity_line_number,
		e.oge_contract_number,
		e.budget_name as oge_budget_name,
		'A' as status_flag,
		'C' as type_of_year
FROM   agreement_snapshot_expanded_cy a, ref_year b, disbursement_line_item_details d, oge_contract e
WHERE a.fiscal_year = b.year_value 
AND a.original_agreement_id = d.agreement_id  AND a.vendor_id = d.vendor_id AND a.fiscal_year >= d.calendar_fiscal_year
AND d.contract_number = e.fms_contract_number AND d.agreement_commodity_line_number = e.fms_commodity_line
AND a.status_flag='A' AND a.master_agreement_yn = 'N' 
UNION ALL
 SELECT d.disbursement_line_item_id, 
		a.original_agreement_id,
		a.fiscal_year,
		b.year_id,
		a.document_code_id,
		a.vendor_id,
		a.award_method_id,
		a.agency_id as document_agency_id,
		a.industry_type_id,
		a.award_size_id,
		d.document_id,
		d.vendor_name,
		d.check_eft_issued_date,
		d.agency_name,
		d.department_short_name,
		d.check_amount,
		d.expenditure_object_name,
		d.budget_name,
		d.contract_number,
		d.purpose,
		d.reporting_code,
		d.spending_category_name,
		d.agency_id,
		d.vendor_id,
		d.expenditure_object_id,
		d.department_id,
		d.spending_category_id,
		d.agreement_id,
		d.contract_document_code,
		d.master_agreement_id,
		d.calendar_fiscal_year_id,
		d.check_eft_issued_cal_month_id,
		d.disbursement_number,
		d.agreement_commodity_line_number,
		e.oge_contract_number,
		e.budget_name as oge_budget_name,
		'A' as status_flag,
		'C' as type_of_year
FROM   agreement_snapshot_expanded_cy a, ref_year b, disbursement_line_item_details d, oge_contract e
WHERE a.fiscal_year = b.year_value 
AND a.original_agreement_id = d.master_agreement_id  AND a.vendor_id = d.vendor_id AND a.fiscal_year >= d.calendar_fiscal_year
AND d.contract_number = e.fms_contract_number AND d.agreement_commodity_line_number = e.fms_commodity_line
AND a.status_flag='A' AND a.master_agreement_yn = 'Y' 
UNION ALL
SELECT 	d.disbursement_line_item_id, 
		a.original_agreement_id,
		a.fiscal_year,
		b.year_id,
		a.document_code_id,
		a.vendor_id,
		a.award_method_id,
		a.agency_id as document_agency_id,
		a.industry_type_id,
		a.award_size_id,
		d.document_id,
		d.vendor_name,
		d.check_eft_issued_date,
		d.agency_name,
		d.department_short_name,
		d.check_amount,
		d.expenditure_object_name,
		d.budget_name,
		d.contract_number,
		d.purpose,
		d.reporting_code,
		d.spending_category_name,
		d.agency_id,
		d.vendor_id,
		d.expenditure_object_id,
		d.department_id,
		d.spending_category_id,
		d.agreement_id,
		d.contract_document_code,
		d.master_agreement_id,
		d.calendar_fiscal_year_id,
		d.check_eft_issued_cal_month_id,
		d.disbursement_number,
		d.agreement_commodity_line_number,
		e.oge_contract_number,
		e.budget_name as oge_budget_name,
		'R' as status_flag,
		'C' as type_of_year
FROM   agreement_snapshot_expanded_cy a, ref_year b, disbursement_line_item_details d, oge_contract e
WHERE a.fiscal_year = b.year_value 
AND a.original_agreement_id = d.agreement_id  AND a.vendor_id = d.vendor_id AND a.fiscal_year >= d.calendar_fiscal_year
AND d.contract_number = e.fms_contract_number AND d.agreement_commodity_line_number = e.fms_commodity_line
AND a.status_flag='R' AND a.master_agreement_yn = 'N'
UNION ALL
SELECT 	d.disbursement_line_item_id, 
		a.original_agreement_id,
		a.fiscal_year,
		b.year_id,
		a.document_code_id,
		a.vendor_id,
		a.award_method_id,
		a.agency_id as document_agency_id,
		a.industry_type_id,
		a.award_size_id,
		d.document_id,
		d.vendor_name,
		d.check_eft_issued_date,
		d.agency_name,
		d.department_short_name,
		d.check_amount,
		d.expenditure_object_name,
		d.budget_name,
		d.contract_number,
		d.purpose,
		d.reporting_code,
		d.spending_category_name,
		d.agency_id,
		d.vendor_id,
		d.expenditure_object_id,
		d.department_id,
		d.spending_category_id,
		d.agreement_id,
		d.contract_document_code,
		d.master_agreement_id,
		d.calendar_fiscal_year_id,
		d.check_eft_issued_cal_month_id,
		d.disbursement_number,
		d.agreement_commodity_line_number,
		e.oge_contract_number,
		e.budget_name as oge_budget_name,
		'R' as status_flag,
		'C' as type_of_year
FROM   agreement_snapshot_expanded_cy a, ref_year b, disbursement_line_item_details d, oge_contract e
WHERE a.fiscal_year = b.year_value 
AND a.original_agreement_id = d.master_agreement_id  AND a.vendor_id = d.vendor_id AND a.fiscal_year >= d.calendar_fiscal_year
AND d.contract_number = e.fms_contract_number AND d.agreement_commodity_line_number = e.fms_commodity_line
AND a.status_flag='R' AND a.master_agreement_yn = 'Y' ",20
ContractsByExpenseCategory,aggregateon_contracts_expense,"CREATE TABLE aggregateon_contracts_expense(
	original_agreement_id bigint,
	expenditure_object_code character varying(4),
	expenditure_object_name character varying(40),
	encumbered_amount numeric(16,2),
	spending_amount_disb numeric(16,2),
	spending_amount numeric(16,2),
	is_disbursements_exist char(1)
) DISTRIBUTED BY (original_agreement_id)","SELECT m.original_agreement_id, m.expenditure_object_code, m.expenditure_object_name, m.encumbered_amount,coalesce(n.spending_amount_disb,0) as spending_amount_disb, m.spending_amount, 
(CASE WHEN n.original_agreement_id IS NULL THEN 'N' ELSE 'Y' END) as is_disbursements_exist
FROM
 (SELECT a.original_agreement_id, d.expenditure_object_code,  d.expenditure_object_name, sum(b.line_amount) as encumbered_amount, sum(b.rfed_line_amount) as spending_amount
 FROM history_agreement a, history_agreement_accounting_line b , ref_expenditure_object_history c, ref_expenditure_object d 
 WHERE a.agreement_id = b.agreement_id AND a.latest_flag = 'Y' AND b.expenditure_object_history_id = c.expenditure_object_history_id AND  c.expenditure_object_id = d.expenditure_object_id
 GROUP BY 1,2,3) m LEFT JOIN
 (SELECT agreement_id as original_agreement_id, expenditure_object_code, sum(check_amount) as spending_amount_disb
 FROM disbursement_line_item_details
 GROUP BY 1,2) n ON m.original_agreement_id = n.original_agreement_id AND m.expenditure_object_code = n.expenditure_object_code ",,21
ContractLandingWidgetsNoVendor,aggregateon_contracts_cumulative_spending_no_vendor,"CREATE TABLE aggregateon_contracts_cumulative_spending_no_vendor(
	original_agreement_id bigint,
	fiscal_year smallint,
	fiscal_year_id smallint,
	document_code_id smallint,
	master_agreement_yn character(1),
	description varchar,
	contract_number varchar,
	award_method_id smallint,
	agency_id smallint,
	industry_type_id smallint,
	award_size_id smallint,
	original_contract_amount numeric(16,2),
	maximum_contract_amount numeric(16,2),
	spending_amount_disb numeric(16,2),
	spending_amount numeric(16,2),
	current_year_spending_amount numeric(16,2),
	dollar_difference numeric(16,2),
	percent_difference numeric(16,2),
	display_agency_id smallint,
	status_flag char(1),
	type_of_year char(1)	
) DISTRIBUTED BY (original_agreement_id)","SELECT  a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		a.master_agreement_yn,
		MIN(description),
		MIN(contract_number),
		MIN(award_method_id),
		MIN(a.agency_id) ,
		MIN(industry_type_id),
		MIN(award_size_id),
		MIN(original_contract_amount),
		MIN(maximum_contract_amount),
		SUM(coalesce(b.check_amount,0)),
		MIN(a.rfed_amount),
		SUM(CASE WHEN b.fiscal_year IS NOT NULL AND a.fiscal_year = b.fiscal_year THEN coalesce(b.check_amount,0) ELSE 0 END) as current_year_spending_amount,
		MIN(dollar_difference),
		MIN(percent_difference),
		(CASE WHEN a.master_agreement_yn = 'Y' THEN agedc.agency_id ELSE a.agency_id END) as display_agency_id,
		'A' as status_flag,
		'B' as type_of_year
	FROM 	(SELECT  original_agreement_id,
		fiscal_year,
		document_code_id,
		master_agreement_yn,
		MIN(description) as description,
		MIN(contract_number) as contract_number,
		MIN(award_method_id) as award_method_id,
		MIN(agency_id) as agency_id,
		MIN(industry_type_id) as industry_type_id,
		MIN(award_size_id) as award_size_id,
		SUM(original_contract_amount) as original_contract_amount,
		SUM(maximum_contract_amount) as maximum_contract_amount,
		MIN(rfed_amount) as rfed_amount,
		MIN(dollar_difference) as dollar_difference,
		MIN(percent_difference) as percent_difference
	FROM 	agreement_snapshot_expanded WHERE  status_flag='A' GROUP BY 1,2,3,4) a 
	LEFT JOIN (SELECT original_agreement_id, fiscal_year, status_flag, master_agreement_yn, agency_id FROM agreement_snapshot_expanded_edc  WHERE master_agreement_yn = 'Y' AND status_flag='A') agedc ON a.original_agreement_id =  agedc.original_agreement_id AND a.fiscal_year = agedc.fiscal_year  AND a.master_agreement_yn = agedc.master_agreement_yn
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN mid_aggregateon_disbursement_spending_year b ON a.original_agreement_id = b.original_agreement_id  AND a.fiscal_year >= b.fiscal_year AND b.type_of_year ='B'
	GROUP BY 1,2,3,4,5,19
UNION ALL
SELECT a.original_agreement_id,
	a.fiscal_year,
	ry.year_id,
	document_code_id,
	a.master_agreement_yn,
	MIN(description),
	MIN(contract_number),
	MIN(award_method_id),
	MIN(a.agency_id) ,
	MIN(industry_type_id),
	MIN(award_size_id),
	MIN(original_contract_amount),
	MIN(maximum_contract_amount),
	SUM(coalesce(b.check_amount,0)) ,
	MIN(a.rfed_amount),
	SUM(CASE WHEN b.fiscal_year IS NOT NULL AND a.fiscal_year = b.fiscal_year THEN coalesce(b.check_amount,0) ELSE 0 END) as current_year_spending_amount,
	MIN(dollar_difference),
	MIN(percent_difference),
	(CASE WHEN a.master_agreement_yn = 'Y' THEN agedc.agency_id ELSE a.agency_id END) as display_agency_id,
	'R' as status_flag, 
	'B' as type_of_year	
	FROM 	(SELECT  original_agreement_id,
		fiscal_year,
		document_code_id,
		master_agreement_yn,
		MIN(description) as description,
		MIN(contract_number) as contract_number,
		MIN(award_method_id) as award_method_id,
		MIN(agency_id) as agency_id,
		MIN(industry_type_id) as industry_type_id,
		MIN(award_size_id) as award_size_id,
		SUM(original_contract_amount) as original_contract_amount,
		SUM(maximum_contract_amount) as maximum_contract_amount,
		MIN(rfed_amount) as rfed_amount,
		MIN(dollar_difference) as dollar_difference,
		MIN(percent_difference) as percent_difference
	FROM 	agreement_snapshot_expanded WHERE  status_flag='R' GROUP BY 1,2,3,4) a 
	LEFT JOIN (SELECT original_agreement_id, fiscal_year, status_flag, master_agreement_yn, agency_id FROM agreement_snapshot_expanded_edc  WHERE master_agreement_yn = 'Y' AND status_flag='R') agedc ON a.original_agreement_id =  agedc.original_agreement_id AND a.fiscal_year = agedc.fiscal_year  AND a.master_agreement_yn = agedc.master_agreement_yn
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN mid_aggregateon_disbursement_spending_year b ON a.original_agreement_id = b.original_agreement_id AND a.fiscal_year >= b.fiscal_year AND b.type_of_year ='B' 
	GROUP BY 1,2,3,4,5,19","SELECT  a.original_agreement_id,
		a.fiscal_year,
		ry.year_id,
		document_code_id,
		a.master_agreement_yn,
		MIN(description),
		MIN(contract_number),
		MIN(award_method_id),
		MIN(a.agency_id) ,
		MIN(industry_type_id),
		MIN(award_size_id),
		MIN(original_contract_amount),
		MIN(maximum_contract_amount),
		SUM(coalesce(b.check_amount,0)),
		MIN(a.rfed_amount),
		SUM(CASE WHEN b.fiscal_year IS NOT NULL AND a.fiscal_year = b.fiscal_year THEN coalesce(b.check_amount,0) ELSE 0 END) as current_year_spending_amount,
		MIN(dollar_difference),
		MIN(percent_difference),
		(CASE WHEN a.master_agreement_yn = 'Y' THEN agedc.agency_id ELSE a.agency_id END) as display_agency_id,
		'A' as status_flag,
		'C' as type_of_year
	FROM 	(SELECT  original_agreement_id,
		fiscal_year,
		document_code_id,
		master_agreement_yn,
		MIN(description) as description,
		MIN(contract_number) as contract_number,
		MIN(award_method_id) as award_method_id,
		MIN(agency_id) as agency_id,
		MIN(industry_type_id) as industry_type_id,
		MIN(award_size_id) as award_size_id,
		SUM(original_contract_amount) as original_contract_amount,
		SUM(maximum_contract_amount) as maximum_contract_amount,
		MIN(rfed_amount) as rfed_amount,
		MIN(dollar_difference) as dollar_difference,
		MIN(percent_difference) as percent_difference
	FROM 	agreement_snapshot_expanded_cy WHERE  status_flag='A' GROUP BY 1,2,3,4) a 
	LEFT JOIN (SELECT original_agreement_id, fiscal_year, status_flag, master_agreement_yn, agency_id FROM agreement_snapshot_expanded_cy_edc  WHERE master_agreement_yn = 'Y' AND status_flag='A') agedc ON a.original_agreement_id =  agedc.original_agreement_id AND a.fiscal_year = agedc.fiscal_year  AND a.master_agreement_yn = agedc.master_agreement_yn
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN mid_aggregateon_disbursement_spending_year b ON a.original_agreement_id = b.original_agreement_id  AND a.fiscal_year >= b.fiscal_year AND b.type_of_year ='C'
	GROUP BY 1,2,3,4,5,19
UNION ALL
SELECT a.original_agreement_id,
	a.fiscal_year,
	ry.year_id,
	document_code_id,
	a.master_agreement_yn,
	MIN(description),
	MIN(contract_number),
	MIN(award_method_id),
	MIN(a.agency_id),
	MIN(industry_type_id),
	MIN(award_size_id),
	MIN(original_contract_amount),
	MIN(maximum_contract_amount),
	SUM(coalesce(b.check_amount,0)) ,
	MIN(a.rfed_amount),
	SUM(CASE WHEN b.fiscal_year IS NOT NULL AND a.fiscal_year = b.fiscal_year THEN coalesce(b.check_amount,0) ELSE 0 END) as current_year_spending_amount,
	MIN(dollar_difference),
	MIN(percent_difference),
	(CASE WHEN a.master_agreement_yn = 'Y' THEN agedc.agency_id ELSE a.agency_id END) as display_agency_id,
	'R' as status_flag, 
	'C' as type_of_year	
	FROM 	(SELECT  original_agreement_id,
		fiscal_year,
		document_code_id,
		master_agreement_yn,
		MIN(description) as description,
		MIN(contract_number) as contract_number,
		MIN(award_method_id) as award_method_id,
		MIN(agency_id) as agency_id,
		MIN(industry_type_id) as industry_type_id,
		MIN(award_size_id) as award_size_id,
		SUM(original_contract_amount) as original_contract_amount,
		SUM(maximum_contract_amount) as maximum_contract_amount,
		MIN(rfed_amount) as rfed_amount,
		MIN(dollar_difference) as dollar_difference,
		MIN(percent_difference) as percent_difference
	FROM 	agreement_snapshot_expanded_cy WHERE  status_flag='R' GROUP BY 1,2,3,4) a 
		LEFT JOIN (SELECT original_agreement_id, fiscal_year, status_flag, master_agreement_yn, agency_id FROM agreement_snapshot_expanded_cy_edc  WHERE master_agreement_yn = 'Y' AND status_flag='R') agedc ON a.original_agreement_id =  agedc.original_agreement_id AND a.fiscal_year = agedc.fiscal_year  AND a.master_agreement_yn = agedc.master_agreement_yn
	LEFT JOIN ref_year ry ON a.fiscal_year = ry.year_value 
	LEFT JOIN mid_aggregateon_disbursement_spending_year b ON a.original_agreement_id = b.original_agreement_id  AND a.fiscal_year >= b.fiscal_year AND b.type_of_year ='C'
	GROUP BY 1,2,3,4,5,19",22
ContractsForSumAndTotalsNoVendor,aggregateon_total_contracts_no_vendor,"CREATE TABLE aggregateon_total_contracts_no_vendor
(
fiscal_year smallint,
fiscal_year_id smallint,
award_method_id smallint,
agency_id smallint,
industry_type_id smallint,
award_size_id smallint,
total_contracts bigint,
total_commited_contracts bigint,
total_master_agreements bigint,
total_standalone_contracts bigint,
total_revenue_contracts bigint,
total_revenue_contracts_amount numeric(16,2),
total_commited_contracts_amount numeric(16,2),
total_contracts_amount numeric(16,2),
total_spending_amount_disb numeric(16,2), 
total_spending_amount numeric(16,2), 
status_flag char(1),
type_of_year char(1)
) DISTRIBUTED BY (fiscal_year)","SELECT 	fiscal_year, 
		fiscal_year_id,
		award_method_id,
		agency_id,
		industry_type_id,
		award_size_id,
		SUM(CASE WHEN b.document_code IN ('MA1','MMA1','CT1','CTA1') THEN 1 ELSE 0 END) AS    total_contracts,
		SUM(CASE WHEN b.document_code IN ('MA1','MMA1','CT1') THEN 1 ELSE 0 END) AS total_commited_contracts,
		SUM(CASE WHEN b.document_code IN ('MA1','MMA1') THEN 1 ELSE 0 END) AS total_master_agreements,
		SUM(CASE WHEN b.document_code IN ('CT1','CTA1') THEN  1 ELSE 0 END) AS total_standalone_contracts,
		SUM(CASE WHEN b.document_code IN ('RCT1') THEN  1 ELSE 0 END) AS total_revenue_contracts,
		SUM(CASE WHEN b.document_code IN ('RCT1') THEN  maximum_contract_amount ELSE 0 END) AS total_revenue_contracts_amount,
		SUM(CASE WHEN b.document_code IN ('MA1','MMA1','CT1') THEN maximum_contract_amount ELSE 0 END) AS total_commited_contracts_amount,
		SUM(CASE WHEN b.document_code IN ('MA1','MMA1','CT1','CTA1') THEN maximum_contract_amount ELSE 0 END) AS total_contracts_amount,
		SUM(CASE WHEN b.document_code IN ('CT1','CTA1','DO1') THEN spending_amount_disb ELSE 0 END) as total_spending_amount_disb,
		SUM(CASE WHEN b.document_code IN ('CT1','CTA1','DO1') THEN spending_amount ELSE 0 END) as total_spending_amount,
		status_flag,
		type_of_year
FROM aggregateon_contracts_cumulative_spending_no_vendor a LEFT JOIN ref_document_code b ON a.document_code_id = b.document_code_id
GROUP BY 1,2,3,4,5,6,17,18",,23
ContractsForVisualizations,aggregateon_contracts_cumulative_spending_visualizations,"CREATE TABLE aggregateon_contracts_cumulative_spending_visualizations(
	original_agreement_id bigint,
	fiscal_year smallint,
	fiscal_year_id smallint,
	document_code_id smallint,
	master_agreement_yn character(1),
	description varchar,
	contract_number varchar,
	vendor_id int,
	award_method_id smallint,
	agency_id smallint,
	industry_type_id smallint,
    award_size_id smallint,
	original_contract_amount numeric(16,2),
	maximum_contract_amount numeric(16,2),
	spending_amount_disb numeric(16,2),
	spending_amount numeric(16,2),
	current_year_spending_amount numeric(16,2),
	dollar_difference numeric(16,2),
	percent_difference numeric(16,2),
	display_agency_id smallint,
	display_vendor_id int,
	display_vendor_name character varying(150),
	is_vendor_page char(1),
	status_flag char(1),
	type_of_year char(1)	
) DISTRIBUTED BY (vendor_id)","SELECT 	original_agreement_id,
	fiscal_year,
	fiscal_year_id,
	document_code_id,
	master_agreement_yn,
	description,
	contract_number,
	a.vendor_id,
	award_method_id,
	agency_id,
	industry_type_id,
    award_size_id,
	original_contract_amount,
	maximum_contract_amount,
	spending_amount_disb,
	spending_amount,
	current_year_spending_amount,
	dollar_difference,
	percent_difference,
	display_agency_id,
	display_vendor_id,
	b.legal_name as display_vendor_name,
	'Y' as is_vendor_page,
	status_flag,
	type_of_year FROM aggregateon_contracts_cumulative_spending a LEFT JOIN vendor b ON a.display_vendor_id = b.vendor_id","SELECT 	original_agreement_id,
	fiscal_year,
	fiscal_year_id,
	document_code_id,
	master_agreement_yn,
	description,
	contract_number,
	a.vendor_id,
	award_method_id,
	agency_id,
	industry_type_id,
    award_size_id,
	original_contract_amount,
	maximum_contract_amount,
	spending_amount_disb,
	spending_amount,
	current_year_spending_amount,
	dollar_difference,
	percent_difference,
	display_agency_id,
	display_vendor_id,
	b.legal_name as display_vendor_name,
	'N' as is_vendor_page,
	status_flag,
	type_of_year FROM aggregateon_contracts_cumulative_spending a LEFT JOIN vendor b ON a.display_vendor_id = b.vendor_id WHERE a.master_agreement_yn = 'N'
	UNION ALL 
	SELECT 	original_agreement_id,
	fiscal_year,
	fiscal_year_id,
	document_code_id,
	master_agreement_yn,
	min(description) as description,
	contract_number,
	NULL as vendor_id,
	award_method_id,
	agency_id,
	industry_type_id,
        award_size_id,
	min(original_contract_amount) as original_contract_amount,
	min(maximum_contract_amount) as maximum_contract_amount,
	sum(spending_amount_disb) as spending_amount_disb,
	min(spending_amount) as spending_amount,
	sum(current_year_spending_amount) as current_year_spending_amount,
	min(dollar_difference) as dollar_difference,
	min(percent_difference) as percent_difference,
	display_agency_id,
	display_vendor_id,
	b.legal_name as display_vendor_name,
	'N' as is_vendor_page,
	status_flag,
	type_of_year FROM aggregateon_contracts_cumulative_spending a LEFT JOIN vendor b ON a.display_vendor_id = b.vendor_id WHERE a.master_agreement_yn = 'Y'
	GROUP BY 1,2,3,4,5,7, 9, 10, 11, 12, 20,21,22,24,25 ",24
ContractsByAppropriationUnitNoVendor,aggregateon_contracts_department_no_vendor,"CREATE TABLE aggregateon_contracts_department_no_vendor(
	document_code_id smallint,
	agency_id smallint,
	department_id integer,
	fiscal_year smallint,
	fiscal_year_id smallint,
	award_method_id smallint,
	industry_type_id smallint,
	award_size_id smallint,
	spending_amount_disb numeric(16,2),
	spending_amount numeric(16,2),
	total_contracts integer,
	status_flag char(1),
	type_of_year char(1)
) DISTRIBUTED BY (department_id)","SELECT a.document_code_id,
 		a.agency_id as agency_id,
		ogecon.department_id as department_id,
		a.fiscal_year,
		a.fiscal_year_id,
		a.award_method_id,
		a.industry_type_id,
		a.award_size_id,
		sum(coalesce(a.spending_amount_disb,0)) as spending_amount_disb,
		sum(coalesce(a.spending_amount,0)) as spending_amount,
		count(distinct a.original_agreement_id) as total_contracts,
		'A' as status_flag,
		'B' as type_of_year
 FROM aggregateon_contracts_cumulative_spending_no_vendor a 
 JOIN (SELECT agency_id, department_id, fms_contract_number, sum(oge_registered_amount) as current_amount
	FROM oge_contract	GROUP BY 1,2,3)  ogecon ON a.contract_number = ogecon.fms_contract_number 
 WHERE  a.master_agreement_yn = 'N' AND a.status_flag='A' AND a.type_of_year = 'B' GROUP BY 1,2,3,4,5,6,7,8	
 UNION ALL 
 SELECT a.document_code_id,
 		a.agency_id as agency_id,
		ogecon.department_id as department_id,
		a.fiscal_year,
		a.fiscal_year_id,
		a.award_method_id,
		a.industry_type_id,
		a.award_size_id,
		sum(coalesce(a.spending_amount_disb,0)) as spending_amount_disb,
		sum(coalesce(a.spending_amount,0)) as spending_amount,
		count(distinct a.original_agreement_id) as total_contracts,
		'R' as status_flag,
		'B' as type_of_year
 FROM aggregateon_contracts_cumulative_spending_no_vendor a 
 JOIN (SELECT agency_id, department_id, fms_contract_number, sum(oge_registered_amount) as current_amount
	FROM oge_contract	GROUP BY 1,2,3)  ogecon ON a.contract_number = ogecon.fms_contract_number 
 WHERE  a.master_agreement_yn = 'N' AND a.status_flag='R' AND a.type_of_year = 'B' GROUP BY 1,2,3,4,5,6,7,8","SELECT a.document_code_id,
 		a.agency_id as agency_id,
		ogecon.department_id as department_id,
		a.fiscal_year,
		a.fiscal_year_id,
		a.award_method_id,
		a.industry_type_id,
		a.award_size_id,
		sum(coalesce(a.spending_amount_disb,0)) as spending_amount_disb,
		sum(coalesce(a.spending_amount,0)) as spending_amount,
		count(distinct a.original_agreement_id) as total_contracts,
		'A' as status_flag,
		'C' as type_of_year
 FROM aggregateon_contracts_cumulative_spending_no_vendor a 
 JOIN (SELECT agency_id, department_id, fms_contract_number, sum(oge_registered_amount) as current_amount
	FROM oge_contract	GROUP BY 1,2,3)  ogecon ON a.contract_number = ogecon.fms_contract_number   
 WHERE  a.master_agreement_yn = 'N' AND a.status_flag='A' AND a.type_of_year = 'C' GROUP BY 1,2,3,4,5,6,7,8
 UNION ALL 
 SELECT a.document_code_id,
 		a.agency_id as agency_id,
		ogecon.department_id as department_id,
		a.fiscal_year,
		a.fiscal_year_id,
		a.award_method_id,
		a.industry_type_id,
		a.award_size_id,
		sum(coalesce(a.spending_amount_disb,0)) as spending_amount_disb,
		sum(coalesce(a.spending_amount,0)) as spending_amount,
		count(distinct a.original_agreement_id) as total_contracts,
		'R' as status_flag,
		'C' as type_of_year
 FROM aggregateon_contracts_cumulative_spending_no_vendor a 
 JOIN (SELECT agency_id, department_id, fms_contract_number, sum(oge_registered_amount) as current_amount
	FROM oge_contract	GROUP BY 1,2,3)  ogecon ON a.contract_number = ogecon.fms_contract_number  
 WHERE  a.master_agreement_yn = 'N' AND a.status_flag='R' AND a.type_of_year = 'C' GROUP BY 1,2,3,4,5,6,7,8",25
 ContractsDetailedTransactions,contracts_detailed_transactions,"CREATE TABLE contracts_detailed_transactions(
  original_agreement_id bigint,
  contract_number character varying,
  document_code_id smallint,
  document_code character varying(8),
  description character varying,
  document_version smallint,
  fiscal_year smallint,
  fiscal_year_id smallint,
  agency_id smallint,
  agency_name character varying(100),  
  vendor_id integer,  
  vendor_name character varying,  
  award_method_id smallint,
  industry_type_id smallint,
  award_size_id smallint,
  agreement_type_name character varying,
  award_method_name character varying,
  expenditure_object_names character varying,
  expenditure_object_codes character varying,
  agreement_type_code character varying(2),
  master_contract_number character varying,
  effective_begin_date date,
  effective_end_date date,
  registered_date date,
  brd_awd_no character varying,
  tracking_number character varying,
  industry_type_name character varying(50),
  dollar_difference numeric(16,2),
  percent_difference numeric(17,4),
  starting_year_id smallint,
  ending_year_id smallint,
  registered_year_id smallint,
  effective_begin_year_id smallint,
  effective_end_year_id smallint,
  fms_commodity_line integer,
  oge_contract_number character varying(15),
  budget_name character varying(75),
  original_contract_amount numeric(16,2),
  maximum_contract_amount numeric(16,2),  
  current_amount_for_transaction numeric(16,2), 
  spending_amount_disb numeric(16,2),
  agreement_id bigint,
  master_agreement_id bigint,
  display_agency_id smallint,
  display_vendor_id integer,
  has_children character(1),
  master_agreement_yn character(1),
  is_vendor_flag character(1),
  if_for_all_years character(1),
  latest_flag character(1),
  status_flag character(1),
  type_of_year character(1)
) DISTRIBUTED BY (original_agreement_id)","SELECT  l1.original_agreement_id,
		l1.contract_number,
		l1.document_code_id,
		l4.document_code,
		l1.description,
		l1.document_version,		
		l3.fiscal_year,
		l3.fiscal_year_id,
		l1.agency_id,
		l1.agency_name,
		l1.vendor_id,
		l1.vendor_name,
		l1.award_method_id,
		l1.industry_type_id,
		l1.award_size_id,
		l1.agreement_type_name,               
		l1.award_method_name,
		l1.expenditure_object_names,
		l1.expenditure_object_codes,
		l1.agreement_type_code,
		l1.master_contract_number,
		l1.effective_begin_date,
		l1.effective_end_date,
		l1.registered_date,
		l1.brd_awd_no,
		l1.tracking_number,
		l1.industry_type_name,
		coalesce(l1.original_contract_amount,0) - coalesce(l2.current_amount_commodity_level,0) as dollar_difference,
		(CASE WHEN coalesce(l1.original_contract_amount,0) = 0 THEN 0 ELSE 
		ROUND((( coalesce(l2.current_amount_commodity_level,0) - coalesce(l1.original_contract_amount,0)) * 100 )::decimal / coalesce(l1.original_contract_amount,0),2) END) as percent_difference,
		l1.starting_year_id,
		l1.ending_year_id,
		l1.registered_year_id,
		l1.effective_begin_year_id,
		l1.effective_end_year_id,
		l2.fms_commodity_line,
		l2.oge_contract_number,
		l2.budget_name,
		l1.original_contract_amount,
		l2.current_amount_commodity_level,
		l2.oge_registered_amount as current_amount_for_transaction,
		l5.check_amount as spending_amount_disb,
		l1.agreement_id,
		l1.master_agreement_id,
		l3.display_agency_id,
		l3.display_vendor_id,
		l1.has_children,
		l1.master_agreement_yn,
		'N' as is_vendor_flag,
		'N' as if_for_all_years,
		l1.latest_flag ,
		l3.status_flag AS status_flag,
		l3.type_of_year AS type_of_year
	  FROM agreement_snapshot l1
		   LEFT OUTER JOIN oge_contract l2 ON l2.fms_contract_number = l1.contract_number AND l1.vendor_id = l2.vendor_id
		   LEFT OUTER JOIN aggregateon_contracts_cumulative_spending l3 ON l3.original_agreement_id = l1.original_agreement_id AND l1.vendor_id = l3.vendor_id
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN (select * from mid_aggregateon_disbursement_spending_year_and_commodity where type_of_year = 'B') l5 ON l1.original_agreement_id = l5.original_agreement_id AND l2.fms_commodity_line = l5.agreement_commodity_line_number AND l3.vendor_id = l5.vendor_id AND l3.fiscal_year = l5.fiscal_year 
	 WHERE  l4.document_code IN ('CT1', 'CTA1') and l3.type_of_year = 'B'
UNION ALL
	SELECT l1.original_agreement_id,
			l1.contract_number,
			l1.document_code_id,
			l4.document_code,
            l1.description,
            l1.document_version,
			l3.fiscal_year,
			l3.fiscal_year_id,
			l3.agency_id,
			ag.agency_name,
			l1.vendor_id,
            l1.vendor_name,
			l1.award_method_id,
			l1.industry_type_id,
			l1.award_size_id,
			l1.agreement_type_name,               
			l1.award_method_name,
            l1.expenditure_object_names,
			l1.expenditure_object_codes,
			l1.agreement_type_code,
			l1.master_contract_number,
            l1.effective_begin_date,
            l1.effective_end_date,
            l1.registered_date,
            l1.brd_awd_no,
            l1.tracking_number,
            l1.industry_type_name,
            l1.dollar_difference,
            l1.percent_difference,
            l1.starting_year_id,
            l1.ending_year_id,
			l1.registered_year_id,
            l1.effective_begin_year_id,
            l1.effective_end_year_id,
            NULL as fms_commodity_line,
			NULL as oge_contract_number,
            NULL as budget_name,
            l1.original_contract_amount,
            l1.maximum_contract_amount,
			l1.maximum_contract_amount as current_amount_for_transaction,
			l3.spending_amount_disb,
			l1.agreement_id,
			l1.master_agreement_id,
			l3.display_agency_id,
			l1.vendor_id as display_vendor_id,
			l1.has_children,
            l1.master_agreement_yn,
			'N' as is_vendor_flag,
			'N' as if_for_all_years,
			l1.latest_flag ,
			l3.status_flag AS status_flag,
            l3.type_of_year AS type_of_year
	  FROM agreement_snapshot l1
		   LEFT OUTER JOIN aggregateon_contracts_cumulative_spending_no_vendor l3 ON l3.original_agreement_id = l1.original_agreement_id 
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN ref_agency ag ON l3.agency_id = ag.agency_id
	 WHERE l4.document_code IN ('MA1', 'MMA1') AND l3.type_of_year = 'B' 
	 UNION ALL 
	 SELECT  l1.original_agreement_id,
		l1.contract_number,
		l1.document_code_id,
		l4.document_code,
		l1.description,
		l1.document_version,		
		l3.fiscal_year,
		l3.fiscal_year_id,
		l1.agency_id,
		l1.agency_name,
		l1.vendor_id,
		l1.vendor_name,
		l1.award_method_id,
		l1.industry_type_id,
		l1.award_size_id,
		l1.agreement_type_name,               
		l1.award_method_name,
		l1.expenditure_object_names,
		l1.expenditure_object_codes,
		l1.agreement_type_code,
		l1.master_contract_number,
		l1.effective_begin_date,
		l1.effective_end_date,
		l1.registered_date,
		l1.brd_awd_no,
		l1.tracking_number,
		l1.industry_type_name,
		coalesce(l1.original_contract_amount,0) - coalesce(l2.current_amount_commodity_level,0) as dollar_difference,
		(CASE WHEN coalesce(l1.original_contract_amount,0) = 0 THEN 0 ELSE 
		ROUND((( coalesce(l2.current_amount_commodity_level,0) - coalesce(l1.original_contract_amount,0)) * 100 )::decimal / coalesce(l1.original_contract_amount,0),2) END) as percent_difference,
		l1.starting_year_id,
		l1.ending_year_id,
		l1.registered_year_id,
		l1.effective_begin_year_id,
		l1.effective_end_year_id,
		l2.fms_commodity_line,
		l2.oge_contract_number,
		l2.budget_name,
		l1.original_contract_amount,
		l2.current_amount_commodity_level,
		l2.oge_registered_amount as current_amount_for_transaction,
		l5.check_amount as spending_amount_disb,
		l1.agreement_id,
		l1.master_agreement_id,
		l3.display_agency_id,
		l3.display_vendor_id,
		l1.has_children,
		l1.master_agreement_yn,
		'Y' as is_vendor_flag,
		'N' as if_for_all_years,
		l1.latest_flag ,
		l3.status_flag AS status_flag,
		l3.type_of_year AS type_of_year
	  FROM agreement_snapshot l1
		   LEFT OUTER JOIN oge_contract l2 ON l2.fms_contract_number = l1.contract_number AND l1.vendor_id = l2.vendor_id
		   LEFT OUTER JOIN aggregateon_contracts_cumulative_spending l3 ON l3.original_agreement_id = l1.original_agreement_id AND l1.vendor_id = l3.vendor_id
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN (select * from mid_aggregateon_disbursement_spending_year_and_commodity where type_of_year = 'B') l5 ON l1.original_agreement_id = l5.original_agreement_id AND l2.fms_commodity_line = l5.agreement_commodity_line_number AND l3.vendor_id = l5.vendor_id AND l3.fiscal_year = l5.fiscal_year
	 WHERE  l4.document_code IN ('CT1', 'CTA1') and l3.type_of_year = 'B' 
	 UNION ALL 
	 SELECT l1.original_agreement_id,
			l1.contract_number,
			l1.document_code_id,
			l4.document_code,
            l1.description,
            l1.document_version,
			l3.fiscal_year,
			l3.fiscal_year_id,
			l3.agency_id,
			ag.agency_name,
			l3.vendor_id,
            ve.legal_name as vendor_name,
			l1.award_method_id,
			l1.industry_type_id,
			l1.award_size_id,
			l1.agreement_type_name,               
			l1.award_method_name,
            l1.expenditure_object_names,
			l1.expenditure_object_codes,
			l1.agreement_type_code,
			l1.master_contract_number,
            l1.effective_begin_date,
            l1.effective_end_date,
            l1.registered_date,
            l1.brd_awd_no,
            l1.tracking_number,
            l1.industry_type_name,
            l1.dollar_difference,
            l1.percent_difference,
            l1.starting_year_id,
            l1.ending_year_id,
			l1.registered_year_id,
            l1.effective_begin_year_id,
            l1.effective_end_year_id,
            NULL as fms_commodity_line,
			NULL as oge_contract_number,
            NULL as budget_name,
            l1.original_contract_amount,
            l1.maximum_contract_amount,
			l1.maximum_contract_amount as current_amount_for_transaction,
			l3.spending_amount_disb,
			l1.agreement_id,
			l1.master_agreement_id,
			l3.display_agency_id,
			l3.display_vendor_id,
			l1.has_children,
            l1.master_agreement_yn,
			'Y' as is_vendor_flag,
			'N' as if_for_all_years,
			l1.latest_flag ,
			l3.status_flag AS status_flag,
            l3.type_of_year AS type_of_year
	  FROM agreement_snapshot l1
		   LEFT OUTER JOIN aggregateon_contracts_cumulative_spending l3 ON l3.original_agreement_id = l1.original_agreement_id 
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN ref_agency ag ON l3.agency_id = ag.agency_id
		   LEFT OUTER JOIN vendor ve ON l3.vendor_id = ve.vendor_id
	 WHERE l4.document_code IN ('MA1', 'MMA1') AND l3.type_of_year = 'B' 
	 UNION ALL 
	 SELECT l1.original_agreement_id,
			l1.contract_number,
			l1.document_code_id,
			l4.document_code,
            l1.description,
            l1.document_version,
			l3.fiscal_year,
			l3.fiscal_year_id,
			l3.agency_id,
			ag.agency_name,
			l1.vendor_id,
            l1.vendor_name,
			l1.award_method_id,
			l1.industry_type_id,
			l1.award_size_id,
			l1.agreement_type_name,               
			l1.award_method_name,
            l1.expenditure_object_names,
			l1.expenditure_object_codes,
			l1.agreement_type_code,
			l1.master_contract_number,
            l1.effective_begin_date,
            l1.effective_end_date,
            l1.registered_date,
            l1.brd_awd_no,
            l1.tracking_number,
            l1.industry_type_name,
            l1.dollar_difference,
            l1.percent_difference,
            l1.starting_year_id,
            l1.ending_year_id,
			l1.registered_year_id,
            l1.effective_begin_year_id,
            l1.effective_end_year_id,
            NULL as fms_commodity_line,
			NULL as oge_contract_number,
            NULL as budget_name,
            l1.original_contract_amount,
            l1.maximum_contract_amount,
			l1.maximum_contract_amount as current_amount_for_transaction,
			l3.spending_amount_disb,
			l1.agreement_id,
			l1.master_agreement_id,
			l3.display_agency_id,
			l1.vendor_id as display_vendor_id,
			l1.has_children,
            l1.master_agreement_yn,
			'Y' as is_vendor_flag,
			'N' as if_for_all_years,
			l1.latest_flag ,
			l3.status_flag AS status_flag,
            l3.type_of_year AS type_of_year
	  FROM agreement_snapshot l1
		   LEFT OUTER JOIN aggregateon_contracts_cumulative_spending_no_vendor l3 ON l3.original_agreement_id = l1.original_agreement_id 
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN ref_agency ag ON l3.agency_id = ag.agency_id
	 WHERE l4.document_code IN ('MA1', 'MMA1') AND l3.type_of_year = 'B'
	 UNION ALL 
	 SELECT  l1.original_agreement_id,
		l1.contract_number,
		l1.document_code_id,
		l4.document_code,
		l1.description,
		l1.document_version,		
		l3.fiscal_year,
		l3.fiscal_year_id,
		l1.agency_id,
		l1.agency_name,
		l1.vendor_id,
		l1.vendor_name,
		l1.award_method_id,
		l1.industry_type_id,
		l1.award_size_id,
		l1.agreement_type_name,               
		l1.award_method_name,
		l1.expenditure_object_names,
		l1.expenditure_object_codes,
		l1.agreement_type_code,
		l1.master_contract_number,
		l1.effective_begin_date,
		l1.effective_end_date,
		l1.registered_date,
		l1.brd_awd_no,
		l1.tracking_number,
		l1.industry_type_name,
		coalesce(l1.original_contract_amount,0) - coalesce(l2.current_amount_commodity_level,0) as dollar_difference,
		(CASE WHEN coalesce(l1.original_contract_amount,0) = 0 THEN 0 ELSE 
		ROUND((( coalesce(l2.current_amount_commodity_level,0) - coalesce(l1.original_contract_amount,0)) * 100 )::decimal / coalesce(l1.original_contract_amount,0),2) END) as percent_difference,
		l1.starting_year_id,
		l1.ending_year_id,
		l1.registered_year_id,
		l1.effective_begin_year_id,
		l1.effective_end_year_id,
		l2.fms_commodity_line,
		l2.oge_contract_number,
		l2.budget_name,
		l1.original_contract_amount,
		l2.current_amount_commodity_level,
		l2.oge_registered_amount as current_amount_for_transaction,
		l5.check_amount as spending_amount_disb,
		l1.agreement_id,
		l1.master_agreement_id,
		l3.display_agency_id,
		l3.display_vendor_id,
		l1.has_children,
		l1.master_agreement_yn,
		'N' as is_vendor_flag,
		'Y' as if_for_all_years,
		l1.latest_flag ,
		l3.status_flag AS status_flag,
		l3.type_of_year AS type_of_year
	  FROM agreement_snapshot l1
		   LEFT OUTER JOIN oge_contract l2 ON l2.fms_contract_number = l1.contract_number AND l1.vendor_id = l2.vendor_id
		   LEFT OUTER JOIN (select original_agreement_id, agency_id, display_agency_id, type_of_year,  status_flag, vendor_id, display_vendor_id,  max(fiscal_year) as fiscal_year, max(fiscal_year_id) as fiscal_year_id, max(spending_amount_disb) as spending_amount_disb from aggregateon_contracts_cumulative_spending where type_of_year = 'B' group by 1,2,3,4,5,6,7) l3 ON l3.original_agreement_id = l1.original_agreement_id AND l1.vendor_id = l3.vendor_id
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN (select original_agreement_id, agreement_commodity_line_number, vendor_id, max(check_amount) as check_amount from mid_aggregateon_disbursement_spending_year_and_commodity where type_of_year = 'B' GROUP BY 1,2,3) l5 ON l1.original_agreement_id = l5.original_agreement_id AND l2.fms_commodity_line = l5.agreement_commodity_line_number AND l3.vendor_id = l5.vendor_id 
	 WHERE  l4.document_code IN ('CT1', 'CTA1') and l3.type_of_year = 'B'
UNION ALL
	SELECT l1.original_agreement_id,
			l1.contract_number,
			l1.document_code_id,
			l4.document_code,
            l1.description,
            l1.document_version,
			l3.fiscal_year,
			l3.fiscal_year_id,
			l3.agency_id,
			ag.agency_name,
			l1.vendor_id,
            l1.vendor_name,
			l1.award_method_id,
			l1.industry_type_id,
			l1.award_size_id,
			l1.agreement_type_name,               
			l1.award_method_name,
            l1.expenditure_object_names,
			l1.expenditure_object_codes,
			l1.agreement_type_code,
			l1.master_contract_number,
            l1.effective_begin_date,
            l1.effective_end_date,
            l1.registered_date,
            l1.brd_awd_no,
            l1.tracking_number,
            l1.industry_type_name,
            l1.dollar_difference,
            l1.percent_difference,
            l1.starting_year_id,
            l1.ending_year_id,
			l1.registered_year_id,
            l1.effective_begin_year_id,
            l1.effective_end_year_id,
            NULL as fms_commodity_line,
			NULL as oge_contract_number,
            NULL as budget_name,
            l1.original_contract_amount,
            l1.maximum_contract_amount,
			l1.maximum_contract_amount as current_amount_for_transaction,
			l5.check_amount as spending_amount_disb,
			l1.agreement_id,
			l1.master_agreement_id,
			l3.display_agency_id,
			l1.vendor_id as display_vendor_id,
			l1.has_children,
            l1.master_agreement_yn,
			'N' as is_vendor_flag,
			'Y' as if_for_all_years,
			l1.latest_flag ,
			l3.status_flag AS status_flag,
            l3.type_of_year AS type_of_year
	  FROM agreement_snapshot l1
		   LEFT OUTER JOIN (select original_agreement_id, agency_id, display_agency_id, type_of_year,  status_flag,   max(fiscal_year) as fiscal_year, max(fiscal_year_id) as fiscal_year_id, max(spending_amount_disb) as spending_amount_disb from aggregateon_contracts_cumulative_spending_no_vendor where type_of_year = 'B' group by 1,2,3,4,5) l3 ON l3.original_agreement_id = l1.original_agreement_id 
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN ref_agency ag ON l3.agency_id = ag.agency_id
		   LEFT OUTER JOIN (select sum(check_amount) as check_amount, master_agreement_id as  original_agreement_id FROM disbursement_line_item_details GROUP BY 2) l5 ON  l3.original_agreement_id = l5.original_agreement_id
	 WHERE l4.document_code IN ('MA1', 'MMA1') AND l3.type_of_year = 'B' AND latest_flag = 'Y'
	 UNION ALL 
	 SELECT  l1.original_agreement_id,
		l1.contract_number,
		l1.document_code_id,
		l4.document_code,
		l1.description,
		l1.document_version,		
		l3.fiscal_year,
		l3.fiscal_year_id,
		l1.agency_id,
		l1.agency_name,
		l1.vendor_id,
		l1.vendor_name,
		l1.award_method_id,
		l1.industry_type_id,
		l1.award_size_id,
		l1.agreement_type_name,               
		l1.award_method_name,
		l1.expenditure_object_names,
		l1.expenditure_object_codes,
		l1.agreement_type_code,
		l1.master_contract_number,
		l1.effective_begin_date,
		l1.effective_end_date,
		l1.registered_date,
		l1.brd_awd_no,
		l1.tracking_number,
		l1.industry_type_name,
		coalesce(l1.original_contract_amount,0) - coalesce(l2.current_amount_commodity_level,0) as dollar_difference,
		(CASE WHEN coalesce(l1.original_contract_amount,0) = 0 THEN 0 ELSE 
		ROUND((( coalesce(l2.current_amount_commodity_level,0) - coalesce(l1.original_contract_amount,0)) * 100 )::decimal / coalesce(l1.original_contract_amount,0),2) END) as percent_difference,
		l1.starting_year_id,
		l1.ending_year_id,
		l1.registered_year_id,
		l1.effective_begin_year_id,
		l1.effective_end_year_id,
		l2.fms_commodity_line,
		l2.oge_contract_number,
		l2.budget_name,
		l1.original_contract_amount,
		l2.current_amount_commodity_level,
		l2.oge_registered_amount as current_amount_for_transaction,
		l5.check_amount as spending_amount_disb,
		l1.agreement_id,
		l1.master_agreement_id,
		l3.display_agency_id,
		l3.display_vendor_id,
		l1.has_children,
		l1.master_agreement_yn,
		'Y' as is_vendor_flag,
		'Y' as if_for_all_years,
		l1.latest_flag ,
		l3.status_flag AS status_flag,
		l3.type_of_year AS type_of_year
	  FROM agreement_snapshot l1
		   LEFT OUTER JOIN oge_contract l2 ON l2.fms_contract_number = l1.contract_number AND l1.vendor_id = l2.vendor_id
		   LEFT OUTER JOIN (select original_agreement_id, agency_id, display_agency_id, type_of_year,  status_flag, vendor_id, display_vendor_id,  max(fiscal_year) as fiscal_year, max(fiscal_year_id) as fiscal_year_id, max(spending_amount_disb) as spending_amount_disb from aggregateon_contracts_cumulative_spending where type_of_year = 'B' group by 1,2,3,4,5,6,7) l3 ON l3.original_agreement_id = l1.original_agreement_id AND l1.vendor_id = l3.vendor_id
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN (select original_agreement_id, agreement_commodity_line_number, vendor_id, max(check_amount) as check_amount from mid_aggregateon_disbursement_spending_year_and_commodity where type_of_year = 'B' GROUP BY 1,2,3) l5 ON l1.original_agreement_id = l5.original_agreement_id AND l2.fms_commodity_line = l5.agreement_commodity_line_number AND l3.vendor_id = l5.vendor_id 
	 WHERE  l4.document_code IN ('CT1', 'CTA1') and l3.type_of_year = 'B' AND latest_flag = 'Y'
	 UNION ALL 
	 SELECT l1.original_agreement_id,
			l1.contract_number,
			l1.document_code_id,
			l4.document_code,
            l1.description,
            l1.document_version,
			l3.fiscal_year,
			l3.fiscal_year_id,
			l3.agency_id,
			ag.agency_name,
			l3.vendor_id,
            ve.legal_name as vendor_name,
			l1.award_method_id,
			l1.industry_type_id,
			l1.award_size_id,
			l1.agreement_type_name,               
			l1.award_method_name,
            l1.expenditure_object_names,
			l1.expenditure_object_codes,
			l1.agreement_type_code,
			l1.master_contract_number,
            l1.effective_begin_date,
            l1.effective_end_date,
            l1.registered_date,
            l1.brd_awd_no,
            l1.tracking_number,
            l1.industry_type_name,
            l1.dollar_difference,
            l1.percent_difference,
            l1.starting_year_id,
            l1.ending_year_id,
			l1.registered_year_id,
            l1.effective_begin_year_id,
            l1.effective_end_year_id,
            NULL as fms_commodity_line,
			NULL as oge_contract_number,
            NULL as budget_name,
            l1.original_contract_amount,
            l1.maximum_contract_amount,
			l1.maximum_contract_amount as current_amount_for_transaction,
			l5.check_amount as spending_amount_disb,
			l1.agreement_id,
			l1.master_agreement_id,
			l3.display_agency_id,
			l3.display_vendor_id,
			l1.has_children,
            l1.master_agreement_yn,
			'Y' as is_vendor_flag,
			'Y' as if_for_all_years,
			l1.latest_flag ,
			l3.status_flag AS status_flag,
            l3.type_of_year AS type_of_year
	  FROM agreement_snapshot l1
		   LEFT OUTER JOIN (select original_agreement_id, agency_id, display_agency_id, type_of_year,  status_flag, vendor_id, display_vendor_id,  max(fiscal_year) as fiscal_year, max(fiscal_year_id) as fiscal_year_id, max(spending_amount_disb) as spending_amount_disb from aggregateon_contracts_cumulative_spending where type_of_year = 'B' group by 1,2,3,4,5,6,7) l3 ON l3.original_agreement_id = l1.original_agreement_id 
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN ref_agency ag ON l3.agency_id = ag.agency_id
		   LEFT OUTER JOIN vendor ve ON l3.vendor_id = ve.vendor_id
		    LEFT OUTER JOIN (select sum(check_amount) as check_amount, master_agreement_id as  original_agreement_id, vendor_id FROM disbursement_line_item_details GROUP BY 2,3) l5 ON  l3.original_agreement_id = l5.original_agreement_id AND l3.vendor_id = l5.vendor_id
	 WHERE l4.document_code IN ('MA1', 'MMA1') AND l3.type_of_year = 'B' AND latest_flag = 'Y' 
	 UNION ALL
	 SELECT l1.original_agreement_id,
			l1.contract_number,
			l1.document_code_id,
			l4.document_code,
            l1.description,
            l1.document_version,
			l3.fiscal_year,
			l3.fiscal_year_id,
			l3.agency_id,
			ag.agency_name,
			l1.vendor_id,
            l1.vendor_name,
			l1.award_method_id,
			l1.industry_type_id,
			l1.award_size_id,
			l1.agreement_type_name,               
			l1.award_method_name,
            l1.expenditure_object_names,
			l1.expenditure_object_codes,
			l1.agreement_type_code,
			l1.master_contract_number,
            l1.effective_begin_date,
            l1.effective_end_date,
            l1.registered_date,
            l1.brd_awd_no,
            l1.tracking_number,
            l1.industry_type_name,
            l1.dollar_difference,
            l1.percent_difference,
            l1.starting_year_id,
            l1.ending_year_id,
			l1.registered_year_id,
            l1.effective_begin_year_id,
            l1.effective_end_year_id,
            NULL as fms_commodity_line,
			NULL as oge_contract_number,
            NULL as budget_name,
            l1.original_contract_amount,
            l1.maximum_contract_amount,
			l1.maximum_contract_amount as current_amount_for_transaction,
			l5.check_amount as spending_amount_disb,
			l1.agreement_id,
			l1.master_agreement_id,
			l3.display_agency_id,
			l1.vendor_id as display_vendor_id,
			l1.has_children,
            l1.master_agreement_yn,
			'Y' as is_vendor_flag,
			'Y' as if_for_all_years,
			l1.latest_flag ,
			l3.status_flag AS status_flag,
            l3.type_of_year AS type_of_year
	  FROM agreement_snapshot l1
		   LEFT OUTER JOIN (select original_agreement_id, agency_id, display_agency_id, type_of_year,  status_flag,   max(fiscal_year) as fiscal_year, max(fiscal_year_id) as fiscal_year_id, max(spending_amount_disb) as spending_amount_disb from aggregateon_contracts_cumulative_spending_no_vendor where type_of_year = 'B' group by 1,2,3,4,5) l3 ON l3.original_agreement_id = l1.original_agreement_id 
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN ref_agency ag ON l3.agency_id = ag.agency_id
		    LEFT OUTER JOIN (select sum(check_amount) as check_amount, master_agreement_id  as original_agreement_id FROM disbursement_line_item_details GROUP BY 2) l5 ON  l3.original_agreement_id = l5.original_agreement_id
	 WHERE l4.document_code IN ('MA1', 'MMA1') AND l3.type_of_year = 'B' AND latest_flag = 'Y' ","SELECT  l1.original_agreement_id,
		l1.contract_number,
		l1.document_code_id,
		l4.document_code,
		l1.description,
		l1.document_version,
		l3.fiscal_year,
		l3.fiscal_year_id,
		l1.agency_id,
		l1.agency_name,
		l1.vendor_id,
		l1.vendor_name,
		l1.award_method_id,
		l1.industry_type_id,
		l1.award_size_id,
		l1.agreement_type_name,               
		l1.award_method_name,
		l1.expenditure_object_names,
		l1.expenditure_object_codes,
		l1.agreement_type_code,
		l1.master_contract_number,
		l1.effective_begin_date,
		l1.effective_end_date,
		l1.registered_date,
		l1.brd_awd_no,
		l1.tracking_number,
		l1.industry_type_name,
		coalesce(l1.original_contract_amount,0) - coalesce(l2.current_amount_commodity_level,0) as dollar_difference,
		(CASE WHEN coalesce(l1.original_contract_amount,0) = 0 THEN 0 ELSE 
		ROUND((( coalesce(l2.current_amount_commodity_level,0) - coalesce(l1.original_contract_amount,0)) * 100 )::decimal / coalesce(l1.original_contract_amount,0),2) END) as percent_difference,
		l1.starting_year_id,
		l1.ending_year_id,
		l1.registered_year_id,
		l1.effective_begin_year_id,
		l1.effective_end_year_id,
		l2.fms_commodity_line,
		l2.oge_contract_number,
		l2.budget_name,
		l1.original_contract_amount,
		l2.current_amount_commodity_level,
		l2.oge_registered_amount as current_amount_for_transaction,
		l5.check_amount as spending_amount_disb,
		l1.agreement_id,
		l1.master_agreement_id,		
		l3.display_agency_id,
		l3.display_vendor_id,
		l1.has_children,
		l1.master_agreement_yn,
		'N' as is_vendor_flag,
		'N' as if_for_all_years,
		l1.latest_flag ,
		l3.status_flag AS status_flag,
		l3.type_of_year AS type_of_year
	  FROM agreement_snapshot_cy l1
		   LEFT OUTER JOIN oge_contract l2 ON l2.fms_contract_number = l1.contract_number AND l1.vendor_id = l2.vendor_id
		   LEFT OUTER JOIN aggregateon_contracts_cumulative_spending l3 ON l3.original_agreement_id = l1.original_agreement_id AND l1.vendor_id = l3.vendor_id
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN (select * from mid_aggregateon_disbursement_spending_year_and_commodity where type_of_year = 'C') l5 ON l1.original_agreement_id = l5.original_agreement_id AND l2.fms_commodity_line = l5.agreement_commodity_line_number AND l3.vendor_id = l5.vendor_id AND l3.fiscal_year = l5.fiscal_year
	 WHERE  l4.document_code IN ('CT1', 'CTA1') and l3.type_of_year = 'C'
UNION ALL
	SELECT l1.original_agreement_id,
			l1.contract_number,
			l1.document_code_id,
			l4.document_code,
            l1.description,
            l1.document_version,
			l3.fiscal_year,
			l3.fiscal_year_id,
			l3.agency_id,
			ag.agency_name,
			l1.vendor_id,
            l1.vendor_name,
			l1.award_method_id,
			l1.industry_type_id,
			l1.award_size_id,
			l1.agreement_type_name,               
			l1.award_method_name,
            l1.expenditure_object_names,
			l1.expenditure_object_codes,
			l1.agreement_type_code,
			l1.master_contract_number,
            l1.effective_begin_date,
            l1.effective_end_date,
            l1.registered_date,
            l1.brd_awd_no,
            l1.tracking_number,
            l1.industry_type_name,
            l1.dollar_difference,
            l1.percent_difference,
            l1.starting_year_id,
            l1.ending_year_id,
			l1.registered_year_id,
            l1.effective_begin_year_id,
            l1.effective_end_year_id,
            NULL as fms_commodity_line,
			NULL as oge_contract_number,
            NULL as budget_name,
            l1.original_contract_amount,
            l1.maximum_contract_amount,
			l1.maximum_contract_amount as current_amount_for_transaction,
			l3.spending_amount_disb,
			l1.agreement_id,
			l1.master_agreement_id,
			l3.display_agency_id,
			l1.vendor_id as display_vendor_id,
			l1.has_children,
            l1.master_agreement_yn,
			'N' as is_vendor_flag,
			'N' as if_for_all_years,
			l1.latest_flag ,
			l3.status_flag AS status_flag,
            l3.type_of_year AS type_of_year
	  FROM agreement_snapshot_cy l1
		   LEFT OUTER JOIN aggregateon_contracts_cumulative_spending_no_vendor l3 ON l3.original_agreement_id = l1.original_agreement_id 
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN ref_agency ag ON l3.agency_id = ag.agency_id
	 WHERE l4.document_code IN ('MA1', 'MMA1') AND l3.type_of_year = 'C' 
	 UNION ALL 
	 SELECT  l1.original_agreement_id,
		l1.contract_number,
		l1.document_code_id,
		l4.document_code,
		l1.description,
		l1.document_version,
		l3.fiscal_year,
		l3.fiscal_year_id,
		l1.agency_id,
		l1.agency_name,
		l1.vendor_id,
		l1.vendor_name,
		l1.award_method_id,
		l1.industry_type_id,
		l1.award_size_id,
		l1.agreement_type_name,               
		l1.award_method_name,
		l1.expenditure_object_names,
		l1.expenditure_object_codes,
		l1.agreement_type_code,
		l1.master_contract_number,
		l1.effective_begin_date,
		l1.effective_end_date,
		l1.registered_date,
		l1.brd_awd_no,
		l1.tracking_number,
		l1.industry_type_name,
		coalesce(l1.original_contract_amount,0) - coalesce(l2.current_amount_commodity_level,0) as dollar_difference,
		(CASE WHEN coalesce(l1.original_contract_amount,0) = 0 THEN 0 ELSE 
		ROUND((( coalesce(l2.current_amount_commodity_level,0) - coalesce(l1.original_contract_amount,0)) * 100 )::decimal / coalesce(l1.original_contract_amount,0),2) END) as percent_difference,
		l1.starting_year_id,
		l1.ending_year_id,
		l1.registered_year_id,
		l1.effective_begin_year_id,
		l1.effective_end_year_id,
		l2.fms_commodity_line,
		l2.oge_contract_number,
		l2.budget_name,
		l1.original_contract_amount,
		l2.current_amount_commodity_level,
		l2.oge_registered_amount as current_amount_for_transaction,
		l5.check_amount as spending_amount_disb,
		l1.agreement_id,
		l1.master_agreement_id,		
		l3.display_agency_id,
		l3.display_vendor_id,
		l1.has_children,
		l1.master_agreement_yn,
		'Y' as is_vendor_flag,
		'N' as if_for_all_years,
		l1.latest_flag ,
		l3.status_flag AS status_flag,
		l3.type_of_year AS type_of_year
	  FROM agreement_snapshot_cy l1
		   LEFT OUTER JOIN oge_contract l2 ON l2.fms_contract_number = l1.contract_number AND l1.vendor_id = l2.vendor_id
		   LEFT OUTER JOIN aggregateon_contracts_cumulative_spending l3 ON l3.original_agreement_id = l1.original_agreement_id AND l1.vendor_id = l3.vendor_id
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN (select * from mid_aggregateon_disbursement_spending_year_and_commodity where type_of_year = 'C') l5 ON l1.original_agreement_id = l5.original_agreement_id AND l2.fms_commodity_line = l5.agreement_commodity_line_number AND l3.vendor_id = l5.vendor_id AND l3.fiscal_year = l5.fiscal_year
	 WHERE  l4.document_code IN ('CT1', 'CTA1') and l3.type_of_year = 'C' 
	 UNION ALL 
	 SELECT l1.original_agreement_id,
			l1.contract_number,
			l1.document_code_id,
			l4.document_code,
            l1.description,
            l1.document_version,
			l3.fiscal_year,
			l3.fiscal_year_id,
			l3.agency_id,
			ag.agency_name,
			l3.vendor_id,
            ve.legal_name as vendor_name,
			l1.award_method_id,
			l1.industry_type_id,
			l1.award_size_id,
			l1.agreement_type_name,               
			l1.award_method_name,
            l1.expenditure_object_names,
			l1.expenditure_object_codes,
			l1.agreement_type_code,
			l1.master_contract_number,
            l1.effective_begin_date,
            l1.effective_end_date,
            l1.registered_date,
            l1.brd_awd_no,
            l1.tracking_number,
            l1.industry_type_name,
            l1.dollar_difference,
            l1.percent_difference,
            l1.starting_year_id,
            l1.ending_year_id,
			l1.registered_year_id,
            l1.effective_begin_year_id,
            l1.effective_end_year_id,
            NULL as fms_commodity_line,
			NULL as oge_contract_number,
            NULL as budget_name,
            l1.original_contract_amount,
            l1.maximum_contract_amount,
			l1.maximum_contract_amount as current_amount_for_transaction,
			l3.spending_amount_disb,
			l1.agreement_id,
			l1.master_agreement_id,
			l3.display_agency_id,
			l3.display_vendor_id,
			l1.has_children,
            l1.master_agreement_yn,
			'Y' as is_vendor_flag,
			'N' as if_for_all_years,
			l1.latest_flag ,
			l3.status_flag AS status_flag,
            l3.type_of_year AS type_of_year
	  FROM agreement_snapshot_cy l1
		   LEFT OUTER JOIN aggregateon_contracts_cumulative_spending l3 ON l3.original_agreement_id = l1.original_agreement_id 
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN ref_agency ag ON l3.agency_id = ag.agency_id
		   LEFT OUTER JOIN vendor ve ON l3.vendor_id = ve.vendor_id
	 WHERE l4.document_code IN ('MA1', 'MMA1') AND l3.type_of_year = 'C' 
	 UNION ALL 
	 SELECT l1.original_agreement_id,
			l1.contract_number,
			l1.document_code_id,
			l4.document_code,
            l1.description,
            l1.document_version,
			l3.fiscal_year,
			l3.fiscal_year_id,
			l3.agency_id,
			ag.agency_name,
			l1.vendor_id,
            l1.vendor_name,
			l1.award_method_id,
			l1.industry_type_id,
			l1.award_size_id,
			l1.agreement_type_name,               
			l1.award_method_name,
            l1.expenditure_object_names,
			l1.expenditure_object_codes,
			l1.agreement_type_code,
			l1.master_contract_number,
            l1.effective_begin_date,
            l1.effective_end_date,
            l1.registered_date,
            l1.brd_awd_no,
            l1.tracking_number,
            l1.industry_type_name,
            l1.dollar_difference,
            l1.percent_difference,
            l1.starting_year_id,
            l1.ending_year_id,
			l1.registered_year_id,
            l1.effective_begin_year_id,
            l1.effective_end_year_id,
            NULL as fms_commodity_line,
			NULL as oge_contract_number,
            NULL as budget_name,
            l1.original_contract_amount,
            l1.maximum_contract_amount,
			l1.maximum_contract_amount as current_amount_for_transaction,
			l3.spending_amount_disb,
			l1.agreement_id,
			l1.master_agreement_id,
			l3.display_agency_id,
			l1.vendor_id as display_vendor_id,
			l1.has_children,
            l1.master_agreement_yn,
			'Y' as is_vendor_flag,
			'N' as if_for_all_years,
			l1.latest_flag ,
			l3.status_flag AS status_flag,
            l3.type_of_year AS type_of_year
	  FROM agreement_snapshot_cy l1
		   LEFT OUTER JOIN aggregateon_contracts_cumulative_spending_no_vendor l3 ON l3.original_agreement_id = l1.original_agreement_id 
		   LEFT OUTER JOIN ref_document_code l4 ON l4.document_code_id = l1.document_code_id
		   LEFT OUTER JOIN ref_agency ag ON l3.agency_id = ag.agency_id
	 WHERE l4.document_code IN ('MA1', 'MMA1') AND l3.type_of_year = 'C'  ",26