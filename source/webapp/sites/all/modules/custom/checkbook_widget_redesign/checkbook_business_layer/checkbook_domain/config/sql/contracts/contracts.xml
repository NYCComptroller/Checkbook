<statements>
    <statement name="GetMasterAgreements" datasource="checkbook">
        <param name="year" required ="true" type="int"/>
        <param name="yeartype" required ="true" type="string" />
        <param name="status_flag" type="string"/>
        <param name="agency_name" type="string" />
        <param name="vendor_name" type="string" />
        <sql>
            SELECT
            type_of_year,
            agency.agency_id,
            agency.agency_short_name as agency_name,
            vendor.vendor_id,
            vendor.legal_name as vendor_name,
            contract_purpose,
            contract_number,
            original_agreement_id,
            document_code_id,
            minority_type_id,
            original_amount_sum,
            current_amount_sum,
            spending_amount_sum
            FROM
            (
            SELECT
            a.type_of_year AS type_of_year,
            a.agency_id AS agency_id,
            a.vendor_id AS vendor_id,
            a.description AS contract_purpose,
            a.contract_number AS contract_number,
            a.original_agreement_id AS original_agreement_id,
            a.document_code_id AS document_code_id,
            a.minority_type_id AS minority_type_id,
            SUM(COALESCE(a.original_contract_amount,0)) AS original_amount_sum,
            SUM(COALESCE(a.maximum_contract_amount,0)) AS current_amount_sum,
            SUM(COALESCE(a.spending_amount,0)) AS spending_amount_sum
            FROM aggregateon_mwbe_contracts_cumulative_spending a
            JOIN ref_document_code b ON a.document_code_id = b.document_code_id
            <where>
                <exp op="AND">
                    <exp op="IN" dbField="b.document_code">('MMA1', 'MA1')</exp>
                    <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                    <exp op="=" dbField="a.fiscal_year_id" paramName="year" />
                    <exp op="=" dbField="a.status_flag" paramName="status_flag" />
                    <exp op="&lt;&gt;" dbField="a.dollar_difference">0</exp>
                </exp>
            </where>
            GROUP BY a.agency_id, a.type_of_year, a.vendor_id, a.description,a.contract_number, a.original_agreement_id, a.document_code_id, a.minority_type_id
            ) AS sub_query
            JOIN ref_agency agency on agency.agency_id = sub_query.agency_id
            JOIN vendor vendor on vendor.vendor_id = sub_query.vendor_id
            <where>
                <exp op="AND">
                    <exp op="=" dbField="vendor.legal_name" paramName="vendor_name" />
                    <exp op="=" dbField="agency.agency_short_name" paramName="agency_name" />
                </exp>
            </where>
        </sql>
    </statement>
    <statement name="GetCountMasterAgreements" datasource="checkbook">
        <param name="year" required ="true" type="int"/>
        <param name="yeartype" required ="true" type="string" />
        <param name="status_flag" type="string"/>
        <param name="agency_name" type="string" />
        <param name="vendor_name" type="string" />
        <sql>
            SELECT count(a.document_code_id) as record_count
            FROM aggregateon_mwbe_contracts_cumulative_spending a
            JOIN ref_document_code b ON a.document_code_id = b.document_code_id
            <where>
                <exp op="AND">
                    <exp op="IN" dbField="b.document_code">('MMA1', 'MA1')</exp>
                    <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                    <exp op="=" dbField="a.fiscal_year_id" paramName="year" />
                    <exp op="=" dbField="a.status_flag" paramName="status_flag" />
                </exp>
            </where>
            HAVING SUM(COALESCE(dollar_difference,0)) != 0
        </sql>
    </statement>
    <statement name="GetMasterAgreementModifications" datasource="checkbook">
        <param name="year" required ="true" type="int"/>
        <param name="yeartype" required ="true" type="string" />
        <param name="status_flag" type="string"/>
        <param name="agency_name" type="string" />
        <param name="vendor_name" type="string" />
        <sql>
            SELECT
            a.type_of_year AS type_of_year,
            a.agency_id AS agency_id,
            c.agency_short_name as agency_name,
            a.vendor_id AS vendor_id,
            d.legal_name AS vendor_name,
            a.description AS contract_purpose,
            a.contract_number AS contract_number,
            a.original_agreement_id AS original_agreement_id,
            a.document_code_id AS document_code_id,
            a.minority_type_id AS minority_type_id,
            SUM(COALESCE(a.original_contract_amount,0)) AS original_amount_sum,
            SUM(COALESCE(a.maximum_contract_amount,0)) AS current_amount_sum,
            SUM(COALESCE(a.spending_amount,0)) AS spending_amount_sum
            FROM aggregateon_mwbe_contracts_cumulative_spending a
            JOIN ref_document_code b ON a.document_code_id = b.document_code_id
            JOIN ref_agency c on c.agency_id = a.agency_id
            JOIN vendor d on d.vendor_id = a.vendor_id
            <where>
                <exp op="AND">
                    <exp op="IN" dbField="b.document_code">('MMA1', 'MA1')</exp>
                    <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                    <exp op="=" dbField="a.fiscal_year_id" paramName="year" />
                    <exp op="=" dbField="a.status_flag" paramName="status_flag" />
                    <exp op="&lt;&gt;" dbField="a.dollar_difference">0</exp>
                </exp>
            </where>
            GROUP BY a.agency_id, a.type_of_year, a.vendor_id, a.description,a.contract_number, a.original_agreement_id, a.document_code_id, a.minority_type_id, c.agency_short_name, d.legal_name
            HAVING SUM(COALESCE(dollar_difference,0)) != 0
        </sql>
    </statement>
    <statement name="GetCountMasterAgreementModifications" datasource="checkbook">
        <param name="year" required ="true" type="int"/>
        <param name="yeartype" required ="true" type="string" />
        <param name="status_flag" type="string"/>
        <param name="agency_name" type="string" />
        <param name="vendor_name" type="string" />
        <sql>
            SELECT count(a.document_code_id) as record_count
            FROM aggregateon_mwbe_contracts_cumulative_spending a
            JOIN ref_document_code b ON a.document_code_id = b.document_code_id
            <where>
                <exp op="AND">
                    <exp op="IN" dbField="b.document_code">('MMA1', 'MA1')</exp>
                    <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                    <exp op="=" dbField="a.fiscal_year_id" paramName="year" />
                    <exp op="=" dbField="a.status_flag" paramName="status_flag" />
                    <exp op="&lt;&gt;" dbField="a.dollar_difference">0</exp>
                </exp>
            </where>
            HAVING SUM(COALESCE(dollar_difference,0)) != 0
        </sql>
    </statement>
</statements>