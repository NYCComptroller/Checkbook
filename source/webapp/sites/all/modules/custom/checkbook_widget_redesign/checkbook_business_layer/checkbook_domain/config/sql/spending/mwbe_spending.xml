<statements>
<!--GetMWBESpendingByAgencies-->
    <statement name="GetMWBESpendingByAgencies" datasource="checkbook">
        <param name="year" required ="true" type="int" />
        <param name="yeartype" required ="true" type="string"/>
        <param name="agency" type="int" />
        <param name="vendor" type="int" />
        <param name="fvendor" type="int" />
        <param name="category" type="int" />
        <param name="industry" type="int" />
        <param name="mwbe"/>
        <sql>
            SELECT s0.type_of_year,
                   s0.year_id AS year_year,
                   s0.agency_id,
                   a.agency_name,
                   SUM(total_spending_amount) AS check_amount_sum,
                   SUM(total_spending_amount)/MAX(total.check_amount)*100 as percent_spending
            FROM aggregateon_mwbe_spending_coa_entities s0
            JOIN ref_agency a ON a.agency_id = s0.agency_id
            JOIN
            (
                SELECT SUM(total_spending_amount) AS check_amount
                FROM aggregateon_mwbe_spending_coa_entities
                    <where>
                        <exp op="AND">
                            <exp op="=" dbField="year_id" paramName="year" />
                            <exp op="=" dbField="type_of_year" paramName="yeartype" />
                            <exp op="=" dbField="vendor_id" paramName="vendor" />
                            <exp op="=" dbField="vendor_id" paramName="fvendor" />
                            <exp op="=" dbField="agency_id" paramName="agency" />
                            <exp op="=" dbField="spending_category_id" paramName="category" />
                            <exp op="=" dbField="industry_type_id" paramName="industry" />
                            <exp op="IN" dbField="minority_type_id" paramName="mwbe" />
                        </exp>
                    </where>
                ) total on 1 = 1
            <where>
                <exp op="AND">
                    <exp op="=" dbField="s0.year_id" paramName="year" />
                    <exp op="=" dbField="s0.type_of_year" paramName="yeartype" />
                    <exp op="=" dbField="s0.vendor_id" paramName="vendor" />
                    <exp op="=" dbField="s0.vendor_id" paramName="fvendor" />
                    <exp op="=" dbField="s0.agency_id" paramName="agency" />
                    <exp op="=" dbField="s0.spending_category_id" paramName="category" />
                    <exp op="=" dbField="s0.industry_type_id" paramName="industry" />
                    <exp op="IN" dbField="s0.minority_type_id" paramName="mwbe" />
                </exp>
            </where>
            GROUP BY s0.agency_id, s0.year_id, s0.type_of_year, a.agency_name
        </sql>
    </statement>
<!--GetMWBESpendingByExpenseCategories-->
    <statement name="GetMWBESpendingByExpenseCategories" datasource="checkbook">
        <param name="year" required ="true" type="int" />
        <param name="yeartype" required ="true" type="string"/>
        <param name="agency" type="int" />
        <param name="vendor" type="int" />
        <param name="fvendor" type="int" />
        <param name="category" type="int" />
        <param name="industry" type="int" />
        <param name="mwbe"/>
        <sql>
            SELECT s0.type_of_year,
                    s0.year_id,
                    s0.expenditure_object_id,
                    j1.original_expenditure_object_name,
                    SUM(total_spending_amount) AS check_amount_sum,
                    SUM(total_spending_amount)/MAX(total.check_amount)*100 as percent_spending
            FROM aggregateon_mwbe_spending_coa_entities s0
            JOIN ref_expenditure_object j1 ON j1.expenditure_object_id = s0.expenditure_object_id
            JOIN
            (
                SELECT SUM(total_spending_amount) AS check_amount
                FROM aggregateon_mwbe_spending_coa_entities
                    <where>
                        <exp op="AND">
                            <exp op="=" dbField="year_id" paramName="year" />
                            <exp op="=" dbField="type_of_year" paramName="yeartype" />
                            <exp op="=" dbField="vendor_id" paramName="vendor" />
                            <exp op="=" dbField="vendor_id" paramName="fvendor" />
                            <exp op="=" dbField="agency_id" paramName="agency" />
                            <exp op="=" dbField="spending_category_id" paramName="category" />
                            <exp op="=" dbField="industry_type_id" paramName="industry" />
                            <exp op="IN" dbField="minority_type_id" paramName="mwbe" />
                        </exp>
                    </where>
            ) total on 1 = 1
            <where>
                <exp op="AND">
                    <exp op="=" dbField="s0.year_id" paramName="year" />
                    <exp op="=" dbField="s0.type_of_year" paramName="yeartype" />
                    <exp op="=" dbField="s0.vendor_id" paramName="vendor" />
                    <exp op="=" dbField="s0.vendor_id" paramName="fvendor" />
                    <exp op="=" dbField="s0.agency_id" paramName="agency" />
                    <exp op="=" dbField="s0.spending_category_id" paramName="category" />
                    <exp op="=" dbField="s0.industry_type_id" paramName="industry" />
                    <exp op="IN" dbField="s0.minority_type_id" paramName="mwbe" />
                </exp>
            </where>
            GROUP BY s0.year_id, s0.type_of_year, s0.expenditure_object_id, j1.original_expenditure_object_name
        </sql>
    </statement>
    <!--GetMWBESpendingByPrimeVendors-->
    <statement name="GetMWBESpendingByPrimeVendors" datasource="checkbook">
        <param name="year" required ="true"/>
        <param name="category" type="int"/>
        <param name="yeartype" required="true" type="string"/>
        <param name="mwbe" />
        <sql>
            SELECT
            a.minority_type_id AS minority_type,
            a.type_of_year AS yeartype,
            a.year_id AS year,
            a.vendor_id AS vendor,
            SUM(COALESCE(total_spending_amount,0)) AS check_amount_sum,
            MAX(COALESCE(total_contract_amount,0)) AS total_contract_amount_sum,
            b.legal_name AS vendor_legal_name
            FROM aggregateon_mwbe_spending_vendor a
            JOIN vendor b ON b.vendor_id = a.vendor_id
            JOIN
            (
            SELECT SUM(total_spending_amount) AS check_amount
            FROM aggregateon_mwbe_spending_vendor
            <where>
                <exp op="AND">
                    <exp op="=" dbField="year_id" paramName="year" />
                    <exp op="=" dbField="type_of_year" paramName="yeartype" />
                    <exp op="=" dbField="vendor_id" paramName="vendor" />
                    <exp op="=" dbField="spending_category_id" paramName="category" />
                    <exp op="IN" dbField="minority_type_id" paramName="mwbe" />
                </exp>
            </where>
            ) total on 1 = 1
            <where>
                <exp op="AND">
                    <exp op="=" dbField="a.year_id" paramName="year" />
                    <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                    <exp op="IN" dbField="a.minority_type_id" paramName="mwbe"/>
                    <exp op="IF" condition="IS_NOT" paramName="category" compareValue="NULL">
                        <exp op="=" dbField="a.spending_category_id" paramName="category" />
                    </exp>
                </exp>
            </where>
            GROUP BY a.vendor_id, a.year_id, a.type_of_year, a.minority_type_id, b.legal_name
        </sql>
    </statement>
    <!-- GetMWBESubVendorsSpendingByPrimeVendors-->
    <statement name="GetMWBESubVendorsSpendingByPrimeVendors" datasource="checkbook">
        <param name="year" required ="true"/>
        <param name="category" type="int"/>
        <param name="yeartype" required="true" type="string"/>
        <param name="mwbe" />
        <sql>
            SELECT
            a.type_of_year AS yeartype_yeartype,
            a.year_id AS year_year,
            a.agency_id AS agency_agency,
            a.prime_vendor_id AS prime_vendor_prime_vendor,
            b.legal_name AS prime_vendor_prime_vendor_legal_name,
            a.prime_minority_type_id AS prime_minority_type_prime_minority_type,
            SUM(COALESCE(total_spending_amount,0)) AS check_amount_sum,
            SUM(COALESCE(total_contract_amount,0)) AS total_contract_amount_sum,
            SUM(COALESCE(total_spending_amount,0))/MAX(total.check_amount)*100 as percent_spending
            FROM aggregateon_subven_spending_vendor a
            JOIN vendor b ON b.vendor_id = a.prime_vendor_id
            JOIN
            (
            SELECT SUM(total_spending_amount) AS check_amount
            FROM aggregateon_subven_spending_vendor
            <where>
                <exp op="AND">
                    <exp op="=" dbField="year_id" paramName="year" />
                    <exp op="IN" dbField="minority_type_id" paramName="mwbe" />
                </exp>
            </where>
            ) total on 1 = 1
            <where>
                <exp op="AND">
                    <exp op="=" dbField="a.year_id" paramName="year" />
                    <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                    <exp op="IN" dbField="a.minority_type_id" paramName="mwbe"/>
                    <exp op="IF" condition="IS_NOT" paramName="category" compareValue="NULL">
                        <exp op="=" dbField="a.spending_category_id" paramName="category" />
                    </exp>
                </exp>
            </where>
            GROUP BY a.year_id, a.type_of_year, a.agency_id, a.prime_vendor_id, a.prime_minority_type_id, b.legal_name
        </sql>
    </statement>
<!--GetMWBESpendingBySubVendors-->
    <statement name="GetMWBESpendingBySubVendors" datasource="checkbook">
        <param name="year" required ="true"/>
        <param name="category" type="int"/>
        <param name="yeartype" required="true" type="string"/>
        <param name="mwbe" />
        <sql>
            SELECT
            a.year_id,
            a.minority_type_id AS minority_type_minority_type,
            a.vendor_id AS sub_vendor_sub_vendor,
            a.agency_id,
            a.prime_vendor_id,
            b.legal_name AS sub_vendor_sub_vendor_legal_name,
            c.legal_name AS prime_vendor_name,
            SUM(COALESCE(total_spending_amount,0)) AS check_amount_sum,
            SUM(COALESCE(total_contract_amount,0)) AS total_contract_amount_sum,
            SUM(total_sub_contracts) AS total_sub_contracts,
            SUM(total_spending_amount) AS ytd_spending_sub_vendors
            FROM aggregateon_subven_spending_vendor a
            JOIN subvendor b ON b.vendor_id = a.vendor_id
            JOIN vendor c ON c.vendor_id = a.prime_vendor_id
            <where>
                <exp op="AND">
                    <exp op="=" dbField="a.year_id" paramName="year" />
                    <exp op="=" dbField="a.type_of_year" paramName="yeartype" />
                    <exp op="IN" dbField="a.minority_type_id" paramName="mwbe"/>
                    <exp op="IF" condition="IS_NOT" paramName="category" compareValue="NULL">
                        <exp op="=" dbField="a.spending_category_id" paramName="category" />
                        <exp op="=" dbField="a.is_all_categories">'N'</exp>
                    </exp>
                    <exp op="IF" condition="IS" paramName="category" compareValue="NULL">
                        <exp op="=" dbField="a.is_all_categories">'Y'</exp>
                    </exp>
                </exp>
            </where>
            GROUP BY a.vendor_id, a.minority_type_id, b.legal_name, a.year_id,  b.legal_name, c.legal_name, a.prime_vendor_id, a.agency_id
        </sql>
    </statement>
</statements>
