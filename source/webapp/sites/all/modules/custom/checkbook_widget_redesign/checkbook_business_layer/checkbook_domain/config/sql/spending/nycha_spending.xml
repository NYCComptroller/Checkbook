<statements>
  <!--GetSpendingByChecks-->
  <statement name="GetNychaSpendingByChecks" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT
        issue_date,
        vendor_name,
        vendor_id,
        check_amount
      FROM all_disbursement_transactions
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      GROUP BY issue_date, vendor_name, vendor_id, check_amount
    </sql>
  </statement>
  <!--GetNychaSpendingByExpenseCategories-->
  <statement name="GetNychaSpendingByExpenseCategories" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT
      s0.expenditure_type_name,
      SUM(s0.ytd_spending) AS check_amount_sum
      FROM public.aggregation_spending_fy s0
      JOIN
      (
      SELECT SUM(ytd_spending) AS ytd_spending
      FROM public.aggregation_spending_fy
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      ) total ON 1 = 1
      <where>
        <exp op="AND">
          <exp op="=" dbField="s0.issue_date_year_id" paramName="year" />
          <exp op="=" dbField="s0.spending_category_id" paramName="category"/>
          <exp op="=" dbField="s0.vendor_id" paramName="vendor" />
          <exp op="=" dbField="s0.industry_type_id" paramName="industry" />
          <exp op="=" dbField="s0.funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      GROUP BY expenditure_type_name
    </sql>
  </statement>
  <!--GetNychaSpendingByVendors-->
  <statement name="GetNychaSpendingByVendors" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT s0.vendor_id,
             s0.vendor_name,
             SUM(s0.ytd_spending) AS check_amount_sum,
             SUM(s0.total_contract_spending)  AS total_contract_amount_sum
      FROM public.aggregation_spending_fy s0
      JOIN
      (
      SELECT SUM(ytd_spending) AS ytd_spending,
             SUM(total_contract_spending) AS total_contract_amount
      FROM aggregation_spending_fy
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      ) total ON 1 = 1
      <where>
        <exp op="AND">
          <exp op="=" dbField="s0.issue_date_year_id" paramName="year" />
          <exp op="=" dbField="s0.spending_category_id" paramName="category"/>
          <exp op="=" dbField="s0.vendor_id" paramName="vendor" />
          <exp op="=" dbField="s0.industry_type_id" paramName="industry" />
          <exp op="=" dbField="s0.funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      GROUP BY s0.vendor_name, s0.vendor_id
    </sql>
  </statement>
  <!--GetNychaSpendingByContracts-->
  <statement name="GetNychaSpendingByContracts" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT contract_id,
        contract_purpose,
        vendor_id,
        vendor_name,
        SUM(COALESCE(ytd_spending, 0)) AS ytd_spending,
        SUM(COALESCE(total_contract_amount, 0)) AS total_contract_amount
      FROM aggregation_spending_contracts_fy
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      GROUP BY contract_id, contract_purpose, vendor_name, vendor_id
    </sql>
  </statement>
  <!--GetCountContracts-->
  <statement name="GetCountContracts" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT DISTINCT contract_id AS contract_id FROM aggregation_spending_contracts_fy
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
    </sql>
  </statement>
  <!--GetNychaSpendingByIndustries-->
  <statement name="GetNychaSpendingByIndustries" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT
        s0.industry_type_id,
        s0.display_industry_type_name AS industry_type_name,
        SUM(check_amount) AS check_amount_sum
      FROM aggregation_spending_fy s0
      JOIN
      (
      SELECT SUM(ytd_spending) AS check_amount FROM aggregation_spending_fy
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      ) total on 1 = 1
      <where>
        <exp op="AND">
          <exp op="=" dbField="s0.issue_date_year_id" paramName="year" />
          <exp op="=" dbField="s0.spending_category_id" paramName="category"/>
          <exp op="=" dbField="s0.vendor_id" paramName="vendor" />
          <exp op="=" dbField="s0.industry_type_id" paramName="industry" />
          <exp op="=" dbField="s0.funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      GROUP BY s0.industry_type_id, s0.display_industry_type_name
    </sql>
  </statement>
  <!--GetNychaSpendingByFundingSource-->
  <statement name="GetNychaSpendingByFundingSource" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT
      s0.funding_source_id,
      s0.display_funding_source_descr AS funding_source_name,
      SUM(check_amount) AS check_amount_sum
      FROM aggregation_spending_fy s0
      JOIN
      (
      SELECT SUM(ytd_spending) AS check_amount FROM aggregation_spending_fy
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      ) total on 1 = 1
      <where>
        <exp op="AND">
          <exp op="=" dbField="s0.issue_date_year_id" paramName="year" />
          <exp op="=" dbField="s0.spending_category_id" paramName="category"/>
          <exp op="=" dbField="s0.vendor_id" paramName="vendor" />
          <exp op="=" dbField="s0.industry_type_id" paramName="industry" />
          <exp op="=" dbField="s0.funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      GROUP BY s0.funding_source_id, s0.display_funding_source_descr
    </sql>
  </statement>
  <!--GetNychaSpendingByDepartment-->
  <statement name="GetNychaSpendingByDepartment" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT
      s0.department_id,
      s0.department_name,
      SUM(check_amount) AS check_amount_sum
      FROM aggregation_spending_fy s0
      JOIN
      (
      SELECT SUM(ytd_spending) AS check_amount FROM aggregation_spending_fy
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      ) total on 1 = 1
      <where>
        <exp op="AND">
          <exp op="=" dbField="s0.issue_date_year_id" paramName="year" />
          <exp op="=" dbField="s0.spending_category_id" paramName="category"/>
          <exp op="=" dbField="s0.vendor_id" paramName="vendor" />
          <exp op="=" dbField="s0.industry_type_id" paramName="industry" />
          <exp op="=" dbField="s0.funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      GROUP BY s0.department_id, s0.department_name
    </sql>
  </statement>
</statements>
