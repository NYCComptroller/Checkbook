<statements>
  <!--GetSpendingByChecks-->
  <statement name="GetNychaSpendingByChecks" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT
        document_id,
        issue_date,
        vendor_name,
        vendor_id,
        MAX(check_amount) as check_amount
      FROM all_disbursement_transactions
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      AND check_status NOT IN ('VOIDED')
      GROUP BY document_id,issue_date, vendor_name, vendor_id
    </sql>
  </statement>
  <!--GetNychaSpendingByExpenseCategories-->
  <statement name="GetNychaSpendingByExpenseCategories" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT
        expenditure_type_description AS expenditure_type_name,
        ytd_spending AS check_amount_sum
      FROM
        (SELECT
        expenditure_type_description ,
        SUM(ytd_spending) AS ytd_spending
        FROM aggregation_spending_fy
        <where>
          <exp op="AND">
            <exp op="=" dbField="issue_date_year_id" paramName="year" />
            <exp op="=" dbField="spending_category_id" paramName="category"/>
            <exp op="=" dbField="vendor_id" paramName="vendor" />
            <exp op="=" dbField="industry_type_id" paramName="industry" />
            <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
          </exp>
        </where>
        GROUP BY expenditure_type_description
        UNION
        SELECT
        display_expenditure_object_name ,
        SUM(total_amount) AS ytd_spending
        FROM aggregation_spending_payroll_fy
        <where>
          <exp op="AND">
            <exp op="=" dbField="issue_date_year_id" paramName="year" />
            <exp op="=" dbField="spending_category_id" paramName="category"/>
            <exp op="=" dbField="vendor_id" paramName="vendor" />
            <exp op="=" dbField="industry_type_id" paramName="industry" />
            <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
          </exp>
        </where>
        GROUP BY display_expenditure_object_name ) z
    </sql>
  </statement>
  <!--GetNychaSpendingByVendors-->
  <statement name="GetNychaSpendingByVendors" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT vendor_id,
             vendor_name,
             SUM(ytd_spending) AS check_amount_sum,
             SUM(total_contract_spending) AS total_contract_amount_sum
      FROM public.aggregation_spending_fy
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      GROUP BY vendor_name, vendor_id
    </sql>
  </statement>
  <!--GetNychaSpendingByContracts-->
  <statement name="GetNychaSpendingByContracts" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT contract_id,
        contract_purpose,
        vendor_id,
        vendor_name,
        SUM(COALESCE(ytd_spending, 0)) AS check_amount_sum,
        MAX(COALESCE(total_contract_amount, 0)) AS total_contract_amount
      FROM aggregation_spending_contracts_fy
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      GROUP BY contract_id, contract_purpose, vendor_name, vendor_id
    </sql>
  </statement>
  <!--GetCountContracts-->
  <statement name="GetCountContracts" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT DISTINCT contract_id AS contract_id FROM aggregation_spending_contracts_fy
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
    </sql>
  </statement>
  <!--GetNychaSpendingByIndustries-->
  <statement name="GetNychaSpendingByIndustries" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT
        industry_type_id AS industry_id,
        display_industry_type_name AS industry_name,
        SUM(ytd_spending) AS check_amount_sum
      FROM aggregation_spending_fy
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      GROUP BY industry_type_id, display_industry_type_name
    </sql>
  </statement>
  <!--GetNychaSpendingByFundingSource-->
  <statement name="GetNychaSpendingByFundingSource" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      SELECT
      funding_source_id,
      display_funding_source_descr AS funding_source_name,
      SUM(ytd_spending) AS check_amount_sum
      FROM aggregation_spending_fy
      <where>
        <exp op="AND">
          <exp op="=" dbField="issue_date_year_id" paramName="year" />
          <exp op="=" dbField="spending_category_id" paramName="category"/>
          <exp op="=" dbField="vendor_id" paramName="vendor" />
          <exp op="=" dbField="industry_type_id" paramName="industry" />
          <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
        </exp>
      </where>
      GROUP BY funding_source_id, display_funding_source_descr
    </sql>
  </statement>
  <!--GetNychaSpendingByDepartment-->
  <statement name="GetNychaSpendingByDepartment" datasource="checkbook_nycha">
    <param name="year" required ="true" type="int" />
    <param name="vendor" type="int" />
    <param name="category" type="int" />
    <param name="industry" type="int" />
    <param name="fundsrc" type="int" />
    <sql>
      <exp op="IF" condition="&lt;&gt;" paramName="category" compareValue="2">
        SELECT
          department_id,
          department_name,
          SUM(ytd_spending) AS check_amount_sum
        FROM aggregation_spending_fy s0
      </exp>
      <exp op="IF" condition="=" paramName="category" compareValue="2">
        SELECT
        citywide_department_id AS department_id,
        citywide_department_name AS department_name,
        SUM(total_amount) AS check_amount_sum
        FROM aggregation_spending_payroll_fy
      </exp>
        <where>
          <exp op="AND">
            <exp op="=" dbField="issue_date_year_id" paramName="year" />
            <exp op="=" dbField="spending_category_id" paramName="category"/>
            <exp op="=" dbField="vendor_id" paramName="vendor" />
            <exp op="=" dbField="industry_type_id" paramName="industry" />
            <exp op="=" dbField="funding_source_id" paramName="fundsrc" />
          </exp>
        </where>
      <exp op="IF" condition="&lt;&gt;" paramName="category" compareValue="2">
        GROUP BY department_id, department_name
      </exp>
      <exp op="IF" condition="=" paramName="category" compareValue="2">
        GROUP BY citywide_department_id, citywide_department_name
      </exp>
    </sql>
  </statement>
</statements>
