<statements>
    <!--GetPercentDifferenceByDepartments-->
    <statement name="GetPercentDifferenceByDepartments" datasource="checkbook">
        <param name="year" required ="true" type="int" />
        <param name="agency" type="int" />
        <param name="expcategory" type="int" />
        <param name="dept" type="int" />
        <sql>
        SELECT s0.budget_fiscal_year_id,
            s0.department_id,
            d.department_name,
            SUM(COALESCE(modified_budget_amount,0)) AS current_amount,
            SUM(COALESCE(modified_budget_amount_py,0)) AS previous_amount,
            SUM(COALESCE(modified_budget_amount_py_1,0)) AS previous_1_amount,
            SUM(COALESCE(modified_budget_amount_py_2,0)) AS previous_2_amount,
            CASE SUM(COALESCE(modified_budget_amount_py,0)) WHEN 0 THEN 0 ELSE ((SUM(COALESCE(modified_budget_amount,0)) - SUM(COALESCE(modified_budget_amount_py,0)))/SUM(COALESCE(modified_budget_amount_py,0)))*100 END AS percent_difference1,
            CASE SUM(COALESCE(modified_budget_amount_py_1,0)) WHEN 0 THEN 0 ELSE ((SUM(COALESCE(modified_budget_amount,0)) - SUM(COALESCE(modified_budget_amount_py_1,0)))/SUM(COALESCE(modified_budget_amount_py_1,0)))*100 END AS percent_difference2,
            CASE SUM(COALESCE(modified_budget_amount_py_2,0)) WHEN 0 THEN 0 ELSE ((SUM(COALESCE(modified_budget_amount,0)) - SUM(COALESCE(modified_budget_amount_py_2,0)))/SUM(COALESCE(modified_budget_amount_py_2,0)))*100 END AS percent_difference3
        FROM aggregateon_budget_by_year s0
        JOIN ref_department d ON s0.department_id = d.department_id
        <where>
            <exp op="AND">
                <exp op="=" dbField="s0.object_class_id" paramName="expcategory" />
                <exp op="=" dbField="s0.budget_fiscal_year_id" paramName="year" />
                <exp op="=" dbField="s0.agency_id " paramName="agency" />
                <exp op="=" dbField="s0.department_id " paramName="dept" />
            </exp>
        </where>
        GROUP BY s0.budget_fiscal_year_id, s0.department_id, d.department_name
        </sql>
    </statement>
    <!--GetBudgetByAgencies-->
    <statement name="GetBudgetByAgencies" datasource="checkbook">
        <param name="objectClassId" required ="true" type="int" />
        <param name="fiscalYear" type="int" />
        <sql>
            SELECT budget.budget_fiscal_year_id AS year_id_year_id,
            budget.agency_id AS agency_id_agency_id,
            budget.agency_name AS agency_name,
            SUM(adopted_amount) AS adopted_budget,
            SUM(COALESCE(current_budget_amount,0)) AS current_modified_budget,
            SUM(total_expenditure_amount) AS committed_budget,
            SUM(remaining_budget) AS remaining_budget
            FROM budget
            <where>
                <exp op="AND">
                    <exp op="=" dbField="budget.object_class_id" paramName="objectClassId" />
                    <exp op="=" dbField="budget.budget_fiscal_year_id" paramName="fiscalYear" />
                </exp>
            </where>
            GROUP BY budget.budget_fiscal_year_id,
            budget.agency_id,
            budget.agency_name
        </sql>
    </statement>
</statements>